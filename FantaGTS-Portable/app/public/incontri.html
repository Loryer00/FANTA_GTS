<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FantaGTS - Incontri e Risultati</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            min-height: 100vh;
            color: #e2e8f0;
            padding: 15px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(0,0,0,0.4);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .section {
            background: rgba(255,255,255,0.08);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }

            .section h2 {
                margin-bottom: 15px;
                color: #4299e1;
                border-bottom: 2px solid #4299e1;
                padding-bottom: 8px;
                font-size: 1.3em;
            }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .btn-primary {
            background: #4299e1;
            color: white;
            border-color: #4299e1;
        }

        .btn-secondary {
            background: #4a5568;
            color: #e2e8f0;
            border-color: #4a5568;
        }

        .turni-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .turno-btn {
            padding: 10px 15px;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

            .turno-btn.active {
                background: #4299e1;
                border-color: #4299e1;
                color: white;
            }

            .turno-btn:hover {
                border-color: #4299e1;
            }

        /* NUOVO LAYOUT A COLONNE */
        .layout-colonne-scontri {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .colonna-scontro {
            background: rgba(45, 55, 72, 0.8);
            border-radius: 12px;
            padding: 15px; /* era 20px */
            border: 2px solid rgba(255,255,255,0.1);
        }

        .header-squadre {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .badge-squadra {
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: bold;
            color: white;
            text-align: center;
            min-width: 120px;
            font-size: 1em;
            line-height: 1.2;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .vs-text {
            font-size: 1.2em;
            font-weight: bold;
            color: #f56565;
        }

        .incontro-block {
            margin-bottom: 15px; /* era 20px */
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 12px; /* era 15px */
            border: 1px solid rgba(255,255,255,0.1);
        }

        .riga-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .btn-azione {
            border: none;
            padding: 5px 12px;
            border-radius: 6px;
            font-size: 0.9em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-reset {
            background: #ed8936;
            color: white;
        }

            .btn-reset:hover {
                background: #dd6b20;
            }

        .btn-conferma {
            background: #48bb78;
            color: white;
        }

            .btn-conferma:hover {
                background: #38a169;
            }

            .btn-conferma:disabled {
                background: #4a5568;
                color: #a0aec0;
                cursor: not-allowed;
                opacity: 0.6;
            }

        .etichetta-coppia {
            font-weight: bold;
            color: white;
            font-size: 1.1em;
        }

        .stato-incontro {
            font-size: 0.85em;
            padding: 4px 8px;
            border-radius: 10px;
            font-weight: bold;
        }

            .stato-incontro.completato {
                background: rgba(72, 187, 120, 0.3);
                color: #48bb78;
            }

            .stato-incontro.attesa {
                background: rgba(237, 137, 54, 0.3);
                color: #ed8936;
            }

        .confronto-coppie {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .coppia-box {
            flex: 1;
            background: rgba(255,255,255,0.08);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            padding: 10px 8px; /* era 15px 12px */
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85em; /* era 0.95em */
            line-height: 1.3; /* era 1.4 */
        }

            .coppia-box:hover {
                background-color: rgba(255,255,255,0.15) !important;
                transform: translateY(-2px);
                transition: all 0.2s ease;
            }

            .coppia-box[style*="pointer-events: auto"] {
                border: 1px solid rgba(66, 153, 225, 0.3);
            }

            .coppia-box.vincitore {
                background-color: rgba(72, 187, 120, 0.2) !important;
                border: 2px solid #48bb78 !important;
                box-shadow: 0 0 10px rgba(72, 187, 120, 0.3);
            }

        .vs-centrale {
            font-size: 1em;
            font-weight: bold;
            color: #f56565;
            min-width: 25px;
            text-align: center;
        }

        /* Colori squadre */
        .gialla {
            background-color: #f59e0b;
        }

        .azzurra {
            background-color: #06b6d4;
        }

        .rossa {
            background-color: #ef4444;
        }

        .verde {
            background-color: #10b981;
        }

        .smeraldo {
            background-color: #10b981;
        }

        .rosa {
            background-color: #ec4899;
        }

        .viola {
            background-color: #8b5cf6;
        }

        .arancione {
            background-color: #f97316;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            z-index: 1001;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

            .notification.show {
                transform: translateX(0);
            }

            .notification.success {
                background: #48bb78;
            }

            .notification.error {
                background: #f56565;
            }

        @keyframes highlight {
            0% {
                background-color: rgba(66, 153, 225, 0.3);
            }

            50% {
                background-color: rgba(66, 153, 225, 0.6);
            }

            100% {
                background-color: transparent;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèüÔ∏è FantaGTS - Incontri e Risultati</h1>
            <p>Visualizza gli incontri e inserisci i risultati delle partite</p>
            <div style="margin-top: 15px;">
                <button class="btn btn-secondary" onclick="tornaAlMaster()">
                    ‚Üê Torna al Master
                </button>
                <button class="btn btn-primary" onclick="vaiAGestione()">
                    ‚öôÔ∏è Gestione Incontri
                </button>
            </div>
        </div>

        <!-- Selezione Turno -->
        <div class="section">
            <h2>üìÖ Seleziona Turno</h2>
            <div id="turniSelector" class="turni-selector">
                <!-- I turni verranno caricati qui -->
            </div>
        </div>

        <!-- Incontri del Turno -->
        <div class="section" id="incontriSection" style="display: none;">
            <h2>üèÜ Incontri - <span id="turnoSelezionatoNome">Turno</span></h2>
            <div id="incontriContainer">
                <!-- Gli incontri verranno caricati qui -->
            </div>
        </div>
    </div>

    <script>
        let turni = [];
        let turnoSelezionato = null;
        let incontriTurno = [];
        let incontriCaricati = [];
        let squadreDisponibili = [];
        let coppieVincenti = new Map();
        let risultatiSelezionati = new Map();

        const selezioniCoppie = new Map(); // Tiene traccia delle selezioni per il nuovo sistema

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', () => {
            caricaSquadre();
            caricaTurni();
        });

        // Funzione per gestire parametri URL
        function gestisciParametriURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const turnoIdDaURL = urlParams.get('turno');

            if (turnoIdDaURL) {
                console.log('üéØ Turno specificato nell\'URL:', turnoIdDaURL);
                // Attendiamo che i turni siano caricati prima di selezionare
                setTimeout(() => selezionaTurnoAutomatico(turnoIdDaURL), 100);
            }
        }

        // Funzione per selezionare automaticamente il turno dall'URL
        async function selezionaTurnoAutomatico(turnoId) {
            const turno = turni.find(t => t.id == turnoId);
            if (turno) {
                console.log('‚úÖ Turno trovato, selezione automatica:', turno);

                // Evidenzia il bottone del turno
                const turnoBtn = [...document.querySelectorAll('.turno-btn')].find(btn =>
                    btn.textContent.includes(`Turno ${turno.turno_numero}`)
                );
                if (turnoBtn) {
                    document.querySelectorAll('.turno-btn').forEach(btn => btn.classList.remove('active'));
                    turnoBtn.classList.add('active');
                }

                // Seleziona il turno
                turnoSelezionato = turno;
                document.getElementById('turnoSelezionatoNome').textContent = `${turno.nome_turno}`;

                // Carica gli incontri del turno
                await caricaIncontriTurno(turno.id);

                document.getElementById('incontriSection').style.display = 'block';
                document.getElementById('incontriSection').scrollIntoView({ behavior: 'smooth' });

                // Gestisci hash per incontro specifico
                if (window.location.hash) {
                    setTimeout(() => {
                        const elementoTarget = document.querySelector(window.location.hash);
                        if (elementoTarget) {
                            elementoTarget.scrollIntoView({ behavior: 'smooth' });
                            // Evidenzia l'incontro
                            elementoTarget.style.animation = 'highlight 2s ease-in-out';
                        }
                    }, 300);
                }
            } else {
                console.warn('‚ö†Ô∏è Turno non trovato per ID:', turnoId);
            }
        }

        // Carica squadre del circolo
        async function caricaSquadre() {
            try {
                console.log('üîÑ Caricamento squadre con giocatori per incontri.html...');

                // Prova il nuovo endpoint specifico per giocatori
                let response = await fetch('/api/squadre-con-giocatori');
                if (!response.ok) {
                    console.log('‚ö†Ô∏è Endpoint squadre-con-giocatori non disponibile, provo squadre-complete');
                    response = await fetch('/api/squadre-complete');
                }

                if (!response.ok) {
                    // Ultimo fallback - endpoint normale e trasformazione manuale
                    console.log('‚ö†Ô∏è Endpoint squadre-complete non disponibile, uso /api/squadre');
                    response = await fetch('/api/squadre');

                    if (response.ok) {
                        const squadre = await response.json();
                        console.log('üîÑ Trasformo manualmente i dati squadre:', squadre);

                        // Trasforma manualmente le squadre dal formato DB
                        squadreDisponibili = squadre.map(squadra => {
                            const giocatori = [];

                            // Aggiungi giocatori maschili
                            for (let i = 1; i <= 7; i++) {
                                const nomeGiocatore = squadra[`m${i}`];
                                if (nomeGiocatore && nomeGiocatore.trim() !== '') {
                                    giocatori.push({
                                        posizione: `M${i}`,
                                        nome: nomeGiocatore.trim()
                                    });
                                }
                            }

                            // Aggiungi giocatori femminili
                            for (let i = 1; i <= 3; i++) {
                                const nomeGiocatore = squadra[`f${i}`];
                                if (nomeGiocatore && nomeGiocatore.trim() !== '') {
                                    giocatori.push({
                                        posizione: `F${i}`,
                                        nome: nomeGiocatore.trim()
                                    });
                                }
                            }

                            console.log(`üéØ Squadra ${squadra.colore} trasformata:`, {
                                numero: squadra.numero,
                                colore: squadra.colore,
                                giocatori: giocatori.length
                            });

                            return {
                                numero: squadra.numero,
                                colore: squadra.colore,
                                giocatori: giocatori
                            };
                        });

                        console.log('‚úÖ Squadre trasformate manualmente:', squadreDisponibili);
                        return;
                    } else {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                }

                squadreDisponibili = await response.json();
                console.log('‚úÖ Squadre con giocatori caricate dal server:', squadreDisponibili);

            } catch (error) {
                console.error('‚ùå Errore caricamento squadre:', error);
                squadreDisponibili = [];
            }
        }

        // Carica turni disponibili
        async function caricaTurni() {
            try {
                const response = await fetch('/api/turni');
                turni = await response.json();

                const container = document.getElementById('turniSelector');
                container.innerHTML = '';

                if (turni.length === 0) {
                    container.innerHTML = '<p>Nessun turno configurato</p>';
                    return;
                }

                turni.forEach(turno => {
                    const btn = document.createElement('div');
                    btn.className = 'turno-btn';
                    btn.textContent = `Turno ${turno.turno_numero}: ${turno.nome_turno}`;
                    btn.onclick = () => selezionaTurno(turno);
                    container.appendChild(btn);
                });

                // AGGIUNGI QUESTA RIGA:
                gestisciParametriURL();

            } catch (error) {
                console.error('Errore caricamento turni:', error);
                showNotification('Errore caricamento turni', 'error');
            }
        }

        // Seleziona turno
        async function selezionaTurno(turno) {
            // Aggiorna UI selezione
            document.querySelectorAll('.turno-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            turnoSelezionato = turno;
            document.getElementById('turnoSelezionatoNome').textContent = `${turno.nome_turno}`;

            // Carica incontri del turno
            await caricaIncontriTurno(turno.id);

            document.getElementById('incontriSection').style.display = 'block';
            document.getElementById('incontriSection').scrollIntoView({ behavior: 'smooth' });
        }

        // Carica incontri del turno selezionato
        async function caricaIncontriTurno(turnoId) {
            try {
                const response = await fetch(`/api/incontri-turno/${turnoId}`);
                incontriCaricati = await response.json();

                const container = document.getElementById('incontriContainer');
                container.innerHTML = '';

                if (incontriCaricati.length === 0) {
                    container.innerHTML = '<p>Nessun incontro generato per questo turno</p>';
                    return;
                }

                // Raggruppa incontri per scontro tra squadre
                const incontriRaggruppati = {};

                incontriCaricati.forEach(incontro => {
                    // Ottieni colori squadre
                    const squadra1 = squadreDisponibili.find(s => s.numero === incontro.squadra1);
                    const squadra2 = squadreDisponibili.find(s => s.numero === incontro.squadra2);

                    const chiaveGruppo = `${squadra1?.colore || 'Sconosciuta'}_vs_${squadra2?.colore || 'Sconosciuta'}`;

                    if (!incontriRaggruppati[chiaveGruppo]) {
                        incontriRaggruppati[chiaveGruppo] = {
                            squadra1: squadra1,
                            squadra2: squadra2,
                            incontri: []
                        };
                    }

                    incontriRaggruppati[chiaveGruppo].incontri.push(incontro);                    
                });

                // Crea il nuovo layout a colonne
                const layoutColonne = document.createElement('div');
                layoutColonne.className = 'layout-colonne-scontri';

                // Crea una colonna per ogni scontro tra squadre
                Object.keys(incontriRaggruppati).forEach((chiaveGruppo) => {
                    const gruppo = incontriRaggruppati[chiaveGruppo];

                    // Crea colonna per lo scontro
                    const colonnaScontro = document.createElement('div');
                    colonnaScontro.className = 'colonna-scontro';

                    // Header dello scontro
                    const headerSquadre = document.createElement('div');
                    headerSquadre.className = 'header-squadre';

                    const squadra1Color = getTeamColor(gruppo.squadra1?.colore);
                    const squadra2Color = getTeamColor(gruppo.squadra2?.colore);

                    headerSquadre.innerHTML = `
    <div class="badge-squadra" style="background-color: ${squadra1Color};">
        SQUADRA<br>${gruppo.squadra1?.colore?.toUpperCase() || 'SCONOSCIUTA'}
    </div>
    <div class="vs-text">VS</div>
    <div class="badge-squadra" style="background-color: ${squadra2Color};">
        SQUADRA<br>${gruppo.squadra2?.colore?.toUpperCase() || 'SCONOSCIUTA'}  
    </div>
`;

                    colonnaScontro.appendChild(headerSquadre);

                    // Aggiungi tutti gli incontri di questo scontro
                    gruppo.incontri.forEach(incontro => {
                        const incontroBlock = document.createElement('div');
                        incontroBlock.className = 'incontro-block';
                        incontroBlock.setAttribute('data-incontro-id', incontro.id);
                        incontroBlock.setAttribute('data-stato', incontro.completato ? 'completato' : 'attesa');

                        // Ottieni nomi giocatori
                        const pos1Squadra1 = gruppo.squadra1?.giocatori?.find(g => g.posizione === incontro.pos1);
                        const pos2Squadra1 = gruppo.squadra1?.giocatori?.find(g => g.posizione === incontro.pos2);
                        const pos1Squadra2 = gruppo.squadra2?.giocatori?.find(g => g.posizione === incontro.pos1);
                        const pos2Squadra2 = gruppo.squadra2?.giocatori?.find(g => g.posizione === incontro.pos2);

                        // Determina il pulsante azione e stato
                        let btnAzione, statoClasse, statoTesto;
                        if (incontro.completato) {
                            btnAzione = `<button class="btn-azione btn-reset" onclick="resetIncontroNuovo('${incontro.id}')">Reset</button>`;
                            statoClasse = 'completato';
                            statoTesto = '‚úì Completato';
                        } else {
                            btnAzione = `<button class="btn-azione btn-conferma" disabled onclick="confermaIncontro('${incontro.id}')">Conferma</button>`;
                            statoClasse = 'attesa';
                            statoTesto = '‚è≥ In attesa';
                        }

                        // Determina quale squadra ha vinto basandosi sui risultati delle coppie
                        let squadra1Vincente = false, squadra2Vincente = false;
                        let coloreVincente = '';
                        if (incontro.completato) {
                            console.log(`üîç Debug incontro ${incontro.id}: risultato_coppia1=${incontro.risultato_coppia1}, risultato_coppia2=${incontro.risultato_coppia2}`);

                            if (incontro.risultato_coppia1 === 'Vittoria') {
                                squadra1Vincente = true;
                                coloreVincente = getTeamColor(gruppo.squadra1.colore);
                                console.log(`‚úÖ Squadra1 vincente: ${gruppo.squadra1.colore} = ${coloreVincente}`);
                            } else if (incontro.risultato_coppia2 === 'Vittoria') {
                                squadra2Vincente = true;
                                coloreVincente = getTeamColor(gruppo.squadra2.colore);
                                console.log(`‚úÖ Squadra2 vincente: ${gruppo.squadra2.colore} = ${coloreVincente}`);
                            }
                        }

                        incontroBlock.innerHTML = `
                    <div class="riga-info">
                        ${btnAzione}
                        <div class="etichetta-coppia">${incontro.pos1} + ${incontro.pos2}</div>
                        <div class="stato-incontro ${statoClasse}">${statoTesto}</div>
                    </div>
                    <div class="confronto-coppie">
                        <div class="coppia-box ${squadra1Vincente ? 'vincitore' : ''}" 
     data-squadra="squadra1" 
     onclick="${!incontro.completato ? `selezionaCoppia('${incontro.id}', 'squadra1')` : ''}"
     style="${incontro.completato ? (squadra1Vincente ?
                                `pointer-events: none; background: linear-gradient(135deg, ${coloreVincente}70, ${coloreVincente}90) !important; border: 3px solid ${coloreVincente} !important; color: #ffffff !important; font-weight: bold !important; text-shadow: 0 2px 4px rgba(0,0,0,0.8) !important; box-shadow: 0 0 20px ${coloreVincente}90 !important;` :
                                'pointer-events: none; opacity: 0.4 !important; filter: grayscale(60%) !important; background: rgba(255,255,255,0.02) !important;') : ''}">
    ${pos1Squadra1?.nome || `N/A(${incontro.pos1})`}<br>${pos2Squadra1?.nome || `N/A(${incontro.pos2})`}
</div>
                        <div class="vs-centrale">vs</div>
                        <div class="coppia-box ${squadra2Vincente ? 'vincitore' : ''}" 
     data-squadra="squadra2" 
     onclick="${!incontro.completato ? `selezionaCoppia('${incontro.id}', 'squadra2')` : ''}"
     style="${incontro.completato ? (squadra1Vincente ?
                                `pointer-events: none; background: linear-gradient(135deg, ${coloreVincente}70, ${coloreVincente}90) !important; border: 3px solid ${coloreVincente} !important; color: #ffffff !important; font-weight: bold !important; text-shadow: 0 2px 4px rgba(0,0,0,0.8) !important; box-shadow: 0 0 20px ${coloreVincente}90 !important;` :
                                'pointer-events: none; opacity: 0.4 !important; filter: grayscale(60%) !important; background: rgba(255,255,255,0.02) !important;') : ''}">
    ${pos1Squadra2?.nome || `N/A(${incontro.pos1})`}<br>${pos2Squadra2?.nome || `N/A(${incontro.pos2})`}
</div>
                    </div>
                `;

                        colonnaScontro.appendChild(incontroBlock);
                    });

                    layoutColonne.appendChild(colonnaScontro);
                });

                // Applica colorazione per incontri gi√† completati
                setTimeout(() => {
                    incontriCaricati.forEach(incontro => {
                        if (incontro.completato) {
                            console.log(`üé® Colorando celle per incontro ${incontro.id}, risultato_coppia1: ${incontro.risultato_coppia1}, risultato_coppia2: ${incontro.risultato_coppia2}`);

                            let squadraVincenteStr = null;
                            if (incontro.risultato_coppia1 === 'Vittoria') {
                                squadraVincenteStr = 'squadra1';
                                console.log(`üîÑ Incontro ${incontro.id}: risultato_coppia1='Vittoria' ‚Üí squadra1`);
                            } else if (incontro.risultato_coppia2 === 'Vittoria') {
                                squadraVincenteStr = 'squadra2';
                                console.log(`üîÑ Incontro ${incontro.id}: risultato_coppia2='Vittoria' ‚Üí squadra2`);
                            }

                            if (squadraVincenteStr) {
                                // Simula la selezione per incontri gi√† completati
                                selezioniCoppie.set(incontro.id, squadraVincenteStr);
                                aggiornaInterfacciaDopoConferma(incontro.id);
                            } else {
                                console.warn(`‚ö†Ô∏è Nessuna vittoria trovata per incontro ${incontro.id} (coppia1: ${incontro.risultato_coppia1}, coppia2: ${incontro.risultato_coppia2})`);
                            }
                        }
                    });
                }, 200);

                container.appendChild(layoutColonne);

                // üÜï SCROLL AUTOMATICO se c'√® un hash nell'URL
                setTimeout(() => {
                    const hash = window.location.hash;
                    if (hash && hash.startsWith('#incontro-')) {
                        const incontroId = hash.replace('#incontro-', '');
                        const elemento = document.querySelector(`[data-incontro-id="${incontroId}"]`);
                        if (elemento) {
                            elemento.scrollIntoView({
                                behavior: 'smooth',
                                block: 'center'
                            });
                            // Evidenzia l'incontro per 3 secondi
                            elemento.style.boxShadow = '0 0 20px #4299e1';
                            elemento.style.transform = 'scale(1.02)';
                            setTimeout(() => {
                                elemento.style.boxShadow = '';
                                elemento.style.transform = '';
                            }, 3000);
                        }
                    }
                }, 1000); // Aspetta 1 secondo che tutto sia caricato

            } catch (error) {
                console.error('Errore caricamento incontri:', error);
                showNotification('Errore nel caricamento degli incontri', 'error');
            }
        }

        // Crea card per un incontro
        async function creaCardIncontro(incontro) {
            const card = document.createElement('div');
            card.className = 'incontro-card-live';
            card.setAttribute('data-incontro-id', incontro.id);

            const squadra1 = squadreDisponibili.find(s => s.numero === incontro.squadra1);
            const squadra2 = squadreDisponibili.find(s => s.numero === incontro.squadra2);

            if (!squadra1 || !squadra2) {
                card.innerHTML = '<p>Errore: squadre non trovate</p>';
                return card;
            }

            card.innerHTML = `
        <div class="incontro-header-live">
            <div class="coppia-info">
                <span class="coppia-numero">Coppia ${incontro.coppia_numero}</span>
                <span class="posizioni">${incontro.pos1} + ${incontro.pos2}</span>
            </div>
            <span class="status-badge ${incontro.completato ? 'completato' : 'in-attesa'}">
                ${incontro.completato ? '‚úÖ Completato' : '‚è≥ In attesa'}
            </span>
        </div>
        
        <div class="coppie-confronto">
            <button class="coppia-btn" data-squadra="1" onclick="selezionaCoppia('${incontro.id}', 1)">
                <div class="coppia-giocatori">
                    <div class="giocatore">${getNomeGiocatore(squadra1, incontro.pos1)} (${incontro.pos1})</div>
                    <div class="giocatore">${getNomeGiocatore(squadra1, incontro.pos2)} (${incontro.pos2})</div>
                </div>
                <div class="squadra-label" style="background-color: ${getTeamColor(squadra1.colore)};">
                    ${squadra1.colore.toUpperCase()}
                </div>
            </button>
            
            <div class="vs-divider">VS</div>
            
            <button class="coppia-btn" data-squadra="2" onclick="selezionaCoppia('${incontro.id}', 2)">
                <div class="coppia-giocatori">
                    <div class="giocatore">${getNomeGiocatore(squadra2, incontro.pos1)} (${incontro.pos1})</div>
                    <div class="giocatore">${getNomeGiocatore(squadra2, incontro.pos2)} (${incontro.pos2})</div>
                </div>
                <div class="squadra-label" style="background-color: ${getTeamColor(squadra2.colore)};">
                    ${squadra2.colore.toUpperCase()}
                </div>
            </button>
        </div>
        
        <div class="azioni-live">
            <button class="btn-completa" onclick="completaIncontro('${incontro.id}')"
                    ${incontro.completato ? 'disabled' : ''}>
                ${incontro.completato ? 'Completato' : 'Completa Incontro'}
            </button>
            <button class="btn-reset" onclick="resetIncontro('${incontro.id}')">
                Reset
            </button>
        </div>
    `;

            return card;
        }

        function getNomeGiocatore(squadra, posizione) {
            const pos = posizione.toLowerCase();
            return squadra[pos] || `${posizione} Non Trovato`;
        }

        function getRisultatoClass(incontroId, posizione, squadra) {
            // Questa funzione restituir√† 'vincitore' se il giocatore ha vinto
            // Per ora restituisce stringa vuota, implementeremo la logica dopo
            return '';
        }

        // Crea dettagli incontro con grid delle posizioni
        async function creaDettagliIncontro(incontro, squadra1, squadra2, dettagliEsistenti) {
            const posizioni = [incontro.pos1, incontro.pos2];
            const teamColor1 = getTeamColor(squadra1.colore);
            const teamColor2 = getTeamColor(squadra2.colore);

            let html = '<div class="posizioni-dettaglio">';

            for (const pos of posizioni) {
                const giocatore1 = squadra1[pos.toLowerCase()] || 'N/A';
                const giocatore2 = squadra2[pos.toLowerCase()] || 'N/A';

                // Cerca dettaglio esistente per questa posizione
                const dettaglio = dettagliEsistenti.find(d => d.posizione === pos);
                const vincitore = dettaglio ? dettaglio.vincitore : 0;

                html += `
                        <div class="posizione-match ${dettaglio ? 'completato' : ''}">
                            <div class="posizione-header">${pos}</div>
                            <div class="match-players">
                                <div class="player-name" style="border-color: ${teamColor1}; ${vincitore === 1 ? 'background: #48bb78; color: white; font-weight: bold;' : ''}">
                                    ${giocatore1}
                                </div>
                                <div class="vs-separator">VS</div>
                                <div class="player-name" style="border-color: ${teamColor2}; ${vincitore === 2 ? 'background: #48bb78; color: white; font-weight: bold;' : ''}">
                                    ${giocatore2}
                                </div>
                            </div>
                            ${!incontro.completato ? `
                                <div class="win-buttons">
                                    <button class="win-btn ${vincitore === 1 ? 'win' : ''}"
                                            onclick="setVincitore(${incontro.id}, '${pos}', 1, '${giocatore1}', '${giocatore2}')">
                                        Vince ${squadra1.colore}
                                    </button>
                                    <button class="win-btn ${vincitore === 2 ? 'win' : ''}"
                                            onclick="setVincitore(${incontro.id}, '${pos}', 2, '${giocatore1}', '${giocatore2}')">
                                        Vince ${squadra2.colore}
                                    </button>
                                </div>
                            ` : `
                                <div style="text-align: center; margin-top: 10px; font-weight: bold; color: #48bb78;">
                                    Vince: ${vincitore === 1 ? squadra1.colore : vincitore === 2 ? squadra2.colore : 'Pareggio'}
                                </div>
                            `}
                        </div>
                    `;
            }

            html += '</div>';

            // Aggiungi pulsanti di controllo se non completato
            if (!incontro.completato) {
                html += `
                        <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 2px solid rgba(255,255,255,0.1);">
                            <button class="btn btn-success" onclick="completaIncontro(${incontro.id})">
                                ‚úÖ Completa Incontro
                            </button>
                            <button class="btn btn-secondary" onclick="resetIncontro(${incontro.id})">
                                üîÑ Reset Risultati
                            </button>
                        </div>
                    `;
            }

            return html;
        }

        // Imposta vincitore per una posizione
        async function setVincitore(incontroId, posizione, vincitore, giocatore1, giocatore2) {
            try {
                const response = await fetch('/api/set-vincitore', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        incontro_id: incontroId,
                        posizione: posizione,
                        vincitore: vincitore,
                        giocatore_squadra1: giocatore1,
                        giocatore_squadra2: giocatore2,
                        punti_assegnati: turnoSelezionato.punti_vittoria
                    })
                });

                if (response.ok) {
                    showNotification(`Vincitore impostato per ${posizione}`, 'success');
                    // Ricarica l'incontro
                    await caricaIncontriTurno(turnoSelezionato.id);
                } else {
                    const error = await response.json();
                    showNotification('Errore: ' + error.error, 'error');
                }
            } catch (error) {
                showNotification('Errore di connessione', 'error');
            }
        }

        // 2. FUNZIONE selezionaCoppia (aggiungere prima di completaIncontro)
        function selezionaCoppia(incontroId, squadra) {
            console.log(`[NUOVA SELEZIONE] Coppia ${squadra} per incontro ${incontroId}`);

            // Salva la selezione
            selezioniCoppie.set(incontroId, squadra);

            // Trova il blocco incontro
            const blocco = document.querySelector(`[data-incontro-id="${incontroId}"]`);
            if (!blocco) return;

            // Rimuovi selezione da tutte le coppie
            const coppie = blocco.querySelectorAll('.coppia-box');
            coppie.forEach(coppia => coppia.classList.remove('vincitore'));

            // Aggiungi selezione alla coppia cliccata
            const coppiaCliccata = Array.from(coppie).find(coppia =>
                coppia.getAttribute('data-squadra') === squadra
            );
            if (coppiaCliccata) {
                coppiaCliccata.classList.add('vincitore');
            }

            // Abilita il pulsante Conferma se l'incontro non √® completato
            const btnConferma = blocco.querySelector('.btn-conferma');
            if (btnConferma) {
                btnConferma.disabled = false;
            }

            showNotification(`Selezionata squadra ${squadra.toUpperCase()}`, 'success');
        }

        // 3. FUNZIONE selezionaVincitore (aggiungere se serve per compatibilit√†)
        function selezionaVincitore(incontroId, posizione, squadra) {
            const key = `${incontroId}_${posizione}`;
            risultatiSelezionati.set(key, squadra);

            // Aggiorna visualmente i bottoni
            const container = document.querySelector(`[data-incontro-id="${incontroId}"]`);
            if (!container) return;

            const posizioneContainer = container.querySelector(`[data-pos="${posizione}"]`);
            if (!posizioneContainer) return;

            // Rimuovi classe vincitore da tutti i bottoni della posizione
            posizioneContainer.querySelectorAll('.giocatore-btn').forEach(btn => {
                btn.classList.remove('vincitore');
            });

            // Aggiungi classe vincitore al bottone cliccato
            const bottoneCliccato = posizioneContainer.querySelector(`[onclick*="'${squadra}'"]`);
            if (bottoneCliccato) {
                bottoneCliccato.classList.add('vincitore');
            }

            showNotification(`Selezionato vincitore per ${posizione}`, 'success');
        }

        // 4. FUNZIONE getRisultatoClass (per compatibilit√†)
        function getRisultatoClass(incontroId, posizione, squadra) {
            // Questa funzione restituir√† 'vincitore' se il giocatore ha vinto
            // Per ora restituisce stringa vuota
            return '';
        }

        // FUNZIONE completaIncontro VECCHIA
        /* async function completaIncontro(incontroId) {
            console.log('[INIZIO] Tentativo di completare incontro ID:', incontroId);

            // Controllo se l'incontro √® gi√† completato
            const incontroContainer = document.querySelector(`[data-incontro-id="${incontroId}"]`);
            if (incontroContainer && (incontroContainer.querySelector('.completato-badge') ||
                incontroContainer.querySelector('.status-badge.completato'))) {
                console.log('[BLOCCO] Incontro gi√† completato');
                showNotification('Questo incontro √® gi√† stato completato!', 'warning');
                return;
            }

            if (!confirm('Completare questo incontro? Non sar√† pi√π possibile modificarlo.')) {
                console.log('[ANNULLATO] Utente ha annullato il completamento');
                return;
            }

            try {
                // SISTEMA ORIGINALE: Verifica squadra selezionata con coppieVincenti
                const squadraSelezionata = coppieVincenti.get(incontroId) ||
                    coppieVincenti.get(parseInt(incontroId)) ||
                    coppieVincenti.get(incontroId.toString());

                console.log('[CHECK] Squadra selezionata:', squadraSelezionata);

                if (!squadraSelezionata) {
                    console.log('[ERRORE] Nessuna squadra selezionata');
                    showNotification('Seleziona prima una squadra vincente!', 'error');
                    return;
                }

                // Trova l'incontro corrente per ottenere le posizioni
                const incontroCorrente = incontriCaricati.find(i => i.id == incontroId);
                if (!incontroCorrente) {
                    throw new Error('Incontro non trovato nei dati caricati');
                }

                console.log('[STEP 1] Incontro trovato:', incontroCorrente);

                // Trova le squadre per ottenere i nomi dei giocatori
                const squadra1 = squadreDisponibili.find(s => s.numero === incontroCorrente.squadra1);
                const squadra2 = squadreDisponibili.find(s => s.numero === incontroCorrente.squadra2);

                if (!squadra1 || !squadra2) {
                    throw new Error('Squadre non trovate');
                }

                console.log('[STEP 2] Squadre trovate:', squadra1.colore, 'vs', squadra2.colore);

                const posizioni = [incontroCorrente.pos1, incontroCorrente.pos2];

                // SISTEMA AUTOMATICO: Imposta vincitori per tutte le posizioni basandosi sulla squadra selezionata
                console.log('[STEP 3] Impostazione automatica vincitori per posizioni:', posizioni);

                for (const posizione of posizioni) {
                    const giocatore1 = squadra1[posizione.toLowerCase()] || 'N/A';
                    const giocatore2 = squadra2[posizione.toLowerCase()] || 'N/A';

                    const requestData = {
                        incontro_id: incontroId,
                        posizione: posizione,
                        vincitore: squadraSelezionata, // 1 o 2
                        giocatore_squadra1: giocatore1,
                        giocatore_squadra2: giocatore2,
                        punti_assegnati: turnoSelezionato?.punti_vittoria || 1
                    };

                    console.log(`[API] Impostazione vincitore per ${posizione}:`, requestData);

                    const response = await fetch('/api/set-vincitore', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestData)
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        console.log(`[ERRORE] Errore set-vincitore per ${posizione}:`, error);
                        showNotification(`Errore impostazione vincitore ${posizione}: ` + error.error, 'error');
                        return;
                    }

                    console.log(`[SUCCESSO] Vincitore impostato per ${posizione}`);
                }

                console.log('[STEP 4] Tutti i vincitori impostati, completando incontro...');

                // Completa l'incontro
                const completaResponse = await fetch(`/api/completa-incontro/${incontroId}`, {
                    method: 'POST'
                });

                if (completaResponse.ok) {
                    const result = await completaResponse.json();
                    console.log('[SUCCESSO] Incontro completato:', result);

                    showNotification(
                        `Incontro completato! ${result.risultato} (${result.vittorie_squadra1}-${result.vittorie_squadra2})`,
                        'success'
                    );

                    // AGGIORNAMENTO UI IMMEDIATO CON DEBUG
                    if (incontroContainer) {
                        console.log('[DEBUG] Container trovato:', incontroContainer);

                        // 1. Aggiorna status badge
                        const statusBadge = incontroContainer.querySelector('.status-badge');
                        console.log('[DEBUG] Status badge trovato:', statusBadge);
                        if (statusBadge) {
                            statusBadge.className = 'status-badge completato';
                            statusBadge.innerHTML = '‚úÖ COMPLETATO';
                            statusBadge.style.background = 'rgba(72, 187, 120, 0.8)';
                            statusBadge.style.color = 'white';
                        }

                        // 2. Disabilita pulsante completa - selettori multipli
                        const completaBtn = incontroContainer.querySelector(`[onclick*="completaIncontro(${incontroId})"]`) ||
                            incontroContainer.querySelector('.btn-completa') ||
                            incontroContainer.querySelector(`button[onclick*="${incontroId}"]`);
                        console.log('[DEBUG] Pulsante completa trovato:', completaBtn);
                        if (completaBtn) {
                            completaBtn.textContent = 'Completato';
                            completaBtn.disabled = true;
                            completaBtn.style.backgroundColor = '#48bb78 !important';
                            completaBtn.style.color = 'white !important';
                            completaBtn.style.cursor = 'not-allowed';
                            completaBtn.removeAttribute('onclick');
                            completaBtn.setAttribute('onclick', 'return false;');
                        }

                        // 3. Disabilita pulsanti selezione squadre
                        const coppiaBtns = incontroContainer.querySelectorAll('.coppia-btn');
                        console.log('[DEBUG] Pulsanti coppia trovati:', coppiaBtns.length);
                        coppiaBtns.forEach((btn, index) => {
                            console.log(`[DEBUG] Disabilitando pulsante ${index + 1}`);
                            btn.style.pointerEvents = 'none';
                            btn.style.opacity = '0.6';
                            btn.style.filter = 'grayscale(50%)';
                            btn.style.cursor = 'not-allowed';
                            btn.removeAttribute('onclick');
                            btn.classList.remove('vincitore');
                        });

                        // 4. Aggiorna bordi e sfondo
                        incontroContainer.style.border = '2px solid #48bb78';
                        incontroContainer.style.background = 'rgba(72, 187, 120, 0.1)';
                        incontroContainer.style.transition = 'all 0.3s ease';

                        // 5. Aggiungi classe completato per CSS
                        incontroContainer.classList.add('incontro-completato');

                        console.log('[UI] Interfaccia aggiornata immediatamente - MIGLIORATA');
                    } else {
                        console.error('[ERROR] Container incontro non trovato per ID:', incontroId);
                    }

                    // Pulizia memoria
                    coppieVincenti.delete(incontroId);
                    coppieVincenti.delete(parseInt(incontroId));
                    coppieVincenti.delete(incontroId.toString());

                    console.log('[STEP 5] Completamento terminato con successo');

                } else {
                    const error = await completaResponse.json();
                    console.log('[ERRORE] Completamento fallito:', error);
                    showNotification('Errore completamento: ' + error.error, 'error');
                }

            } catch (generalError) {
                console.error('[ERRORE] Errore generale:', generalError);
                showNotification('Errore di connessione: ' + generalError.message, 'error');
            }

            console.log('[FINE] Processo completamento terminato per incontro', incontroId);
        } */

        // Reset incontro VECCHIA
        /* async function resetIncontro(incontroId) {
            if (!confirm('Resettare tutti i risultati di questo incontro?')) return;

            try {
                const response = await fetch(`/api/reset-incontro/${incontroId}`, {
                    method: 'POST'
                });

                if (response.ok) {
                    showNotification('Incontro resettato', 'success');
                    await caricaIncontriTurno(turnoSelezionato.id);
                } else {
                    const error = await response.json();
                    showNotification('Errore: ' + error.error, 'error');
                }
            } catch (error) {
                showNotification('Errore di connessione', 'error');
            }
        } */

        // FUNZIONE: Conferma incontro (passa da "Conferma" a "Reset" + "Completato")
        async function confermaIncontro(incontroId) {
            const squadraSelezionata = selezioniCoppie.get(incontroId);
            if (!squadraSelezionata) {
                showNotification('Seleziona prima una coppia vincente!', 'error');
                return;
            }

            try {
                // Trova l'incontro nei dati caricati
                const incontroData = incontriCaricati.find(i => i.id == incontroId);
                if (!incontroData) {
                    throw new Error('Dati incontro non trovati');
                }

                // üîß CORREZIONE: Usa il numero corretto della squadra
                const posizioni = [incontroData.pos1, incontroData.pos2];
                const numeroSquadraVincente = squadraSelezionata === 'squadra1' ? incontroData.squadra1 : incontroData.squadra2;
                const numVincitore = squadraSelezionata === 'squadra1' ? 1 : 2;

                console.log(`üîß Correzione: squadraSelezionata=${squadraSelezionata}, numeroSquadraVincente=${numeroSquadraVincente}, numVincitore=${numVincitore}`);

                console.log(`[AUTO-SETUP] Creazione risultati per posizioni: ${posizioni.join(', ')}`);

                // Crea risultati per ogni posizione (automaticamente vince la squadra selezionata)
                for (const posizione of posizioni) {
                    const requestData = {
                        incontro_id: incontroId,
                        posizione: posizione,
                        vincitore: numVincitore, // 1 = squadra1, 2 = squadra2
                        giocatore_squadra1: `Giocatore ${posizione} Squadra ${incontroData.squadra1}`,
                        giocatore_squadra2: `Giocatore ${posizione} Squadra ${incontroData.squadra2}`,
                        punti_assegnati: turnoSelezionato?.punti_vittoria || 1
                    };

                    const response = await fetch('/api/set-vincitore', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestData)
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(`Errore impostazione ${posizione}: ${error.error}`);
                    }

                    console.log(`[OK] Vincitore ${posizione} impostato`);
                }

                // Ora completa l'incontro (dovrebbe funzionare perch√© abbiamo i risultati)
                const completaResponse = await fetch(`/api/completa-incontro/${incontroId}`, {
                    method: 'POST'
                });

                if (!completaResponse.ok) {
                    const error = await completaResponse.json();
                    throw new Error(error.error);
                }

                // Successo!
                const result = await completaResponse.json();
                console.log('[SUCCESSO] Incontro completato:', result);

                // Aggiorna interfaccia locale
                aggiornaInterfacciaDopoConferma(incontroId);
                showNotification(`Incontro completato! ${result.risultato}`, 'success');

                // Salva anche nel sistema esistente per compatibilit√†
                coppieVincenti.set(incontroId, squadraSelezionata);

            } catch (error) {
                console.error('[ERRORE CONFERMA]', error);
                showNotification(`Errore: ${error.message}`, 'error');
            }
        }

        // FUNZIONE: Aggiorna interfaccia dopo conferma
        function aggiornaInterfacciaDopoConferma(incontroId) {
            const blocco = document.querySelector(`[data-incontro-id="${incontroId}"]`);
            if (!blocco) return;

            // Trova l'incontro nei dati per ottenere i colori delle squadre
            const incontro = incontriCaricati.find(i => i.id == incontroId);
            if (!incontro) return;

            const squadra1 = squadreDisponibili.find(s => s.numero === incontro.squadra1);
            const squadra2 = squadreDisponibili.find(s => s.numero === incontro.squadra2);
            if (!squadra1 || !squadra2) return;

            // Ottieni quale squadra ha vinto
            const squadraVincente = selezioniCoppie.get(incontroId);
            console.log(`üé® Colorando celle per incontro ${incontroId}, vincitore: ${squadraVincente}`);

            // Determina il colore della squadra vincente e quale coppia colorare
            let coloreVincente;
            let squadraVincenteAttr; // 'squadra1' o 'squadra2'

            // Se squadraVincente √® una stringa ('squadra1'/'squadra2'), usala direttamente
            if (squadraVincente === 'squadra1' || squadraVincente === 'squadra2') {
                squadraVincenteAttr = squadraVincente;
                if (squadraVincente === 'squadra1') {
                    coloreVincente = getTeamColor(squadra1.colore);
                } else {
                    coloreVincente = getTeamColor(squadra2.colore);
                }
            } else {
                // Se squadraVincente √® un numero (dalla DB), converti in 'squadra1'/'squadra2'
                if (squadraVincente == incontro.squadra1) {
                    squadraVincenteAttr = 'squadra1';
                    coloreVincente = getTeamColor(squadra1.colore);
                } else if (squadraVincente == incontro.squadra2) {
                    squadraVincenteAttr = 'squadra2';
                    coloreVincente = getTeamColor(squadra2.colore);
                }
            }

            console.log(`üîß Debug: squadraVincente=${squadraVincente}, squadraVincenteAttr=${squadraVincenteAttr}, colore=${coloreVincente}`);

            // Colora le celle dei giocatori
            const coppie = blocco.querySelectorAll('.coppia-box');
            coppie.forEach(coppia => {
                const squadraAttr = coppia.getAttribute('data-squadra');

                const vincitore = (squadraAttr === squadraVincente);

                if (vincitore) {
                    // Applica stile vincente con colori PI√ô FORTI
                    coppia.style.background = `linear-gradient(135deg, ${coloreVincente}70, ${coloreVincente}90) !important`;
                    coppia.style.border = `3px solid ${coloreVincente} !important`;
                    coppia.style.color = '#ffffff !important';
                    coppia.style.fontWeight = 'bold !important';
                    coppia.style.textShadow = '0 2px 4px rgba(0,0,0,0.8) !important';
                    coppia.style.boxShadow = `0 0 20px ${coloreVincente}90 !important`;
                } else {
                    // Stile perdente PI√ô EVIDENTE
                    coppia.style.opacity = '0.4 !important';
                    coppia.style.filter = 'grayscale(60%) !important';
                    coppia.style.background = 'rgba(255,255,255,0.02) !important';
                }

                // Disabilita il click (incontro completato)
                coppia.style.pointerEvents = 'none';
            });

            // Aggiorna stato del blocco
            blocco.setAttribute('data-stato', 'completato');

            // Cambia pulsante da "Conferma" a "Reset"
            const rigaInfo = blocco.querySelector('.riga-info');
            const btnAzione = rigaInfo.querySelector('.btn-azione');
            btnAzione.className = 'btn-azione btn-reset';
            btnAzione.textContent = 'Reset';
            btnAzione.disabled = false;
            btnAzione.setAttribute('onclick', `resetIncontroNuovo('${incontroId}')`);

            // Aggiorna stato da "‚è≥ In attesa" a "‚úì Completato"
            const statoElement = rigaInfo.querySelector('.stato-incontro');
            statoElement.className = 'stato-incontro completato';
            statoElement.textContent = '‚úì Completato';

            // Aggiorna anche l'overview se siamo in gestione-incontri
            if (typeof aggiornaOverviewDopoConferma === 'function') {
                aggiornaOverviewDopoConferma(incontroId, squadraVincente);
            }
        }

        // FUNZIONE: Reset incontro (nuovo sistema)
        async function resetIncontroNuovo(incontroId) {
            if (!confirm('Resettare questo incontro? Dovrai selezionare nuovamente il vincitore.')) {
                return;
            }

            console.log(`[RESET NUOVO] Incontro ${incontroId}`);

            try {
                // Chiamata API per resettare
                const response = await fetch(`/api/reset-incontro/${incontroId}`, {
                    method: 'POST'
                });

                if (response.ok) {
                    // Rimuovi la selezione dalle mappe
                    selezioniCoppie.delete(incontroId);
                    coppieVincenti.delete(incontroId);

                    // Aggiorna interfaccia locale
                    aggiornaInterfacciaDopoReset(incontroId);
                    showNotification('Incontro resettato con successo!', 'success');
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Errore durante il reset');
                }

            } catch (error) {
                console.error('[ERRORE RESET]', error);
                showNotification(`Errore: ${error.message}`, 'error');
            }
        }

        // FUNZIONE: Aggiorna interfaccia dopo reset
        function aggiornaInterfacciaDopoReset(incontroId) {
            console.log(`[AGGIORNA UI RESET] Incontro ${incontroId}`);

            const blocco = document.querySelector(`[data-incontro-id="${incontroId}"]`);
            if (!blocco) {
                console.error(`Blocco incontro ${incontroId} non trovato!`);
                return;
            }

            // Aggiorna stato del blocco
            blocco.setAttribute('data-stato', 'attesa');

            // Cambia pulsante da "Reset" a "Conferma" disabilitato
            const rigaInfo = blocco.querySelector('.riga-info');
            const btnAzione = rigaInfo.querySelector('.btn-azione');
            if (btnAzione) {
                btnAzione.className = 'btn-azione btn-conferma';
                btnAzione.textContent = 'Conferma';
                btnAzione.disabled = true;
                btnAzione.setAttribute('onclick', `confermaIncontro('${incontroId}')`);
            }

            // Aggiorna stato da "‚úì Completato" a "‚è≥ In attesa"
            const statoElement = rigaInfo.querySelector('.stato-incontro');
            if (statoElement) {
                statoElement.className = 'stato-incontro attesa';
                statoElement.textContent = '‚è≥ In attesa';
            }

            // ‚ö†Ô∏è FIX CRITICO: Riabilita selezione coppie e RESET COMPLETO STILI
            const coppie = blocco.querySelectorAll('.coppia-box');
            coppie.forEach(coppia => {
                // Rimuovi vincitore
                coppia.classList.remove('vincitore');

                // RESET COMPLETO di tutti gli stili applicati
                coppia.style.pointerEvents = 'auto';
                coppia.style.opacity = '1';
                coppia.style.background = 'rgba(255,255,255,0.08)';
                coppia.style.borderColor = 'rgba(255,255,255,0.2)';
                coppia.style.color = '#e2e8f0';
                coppia.style.fontWeight = 'normal';
                coppia.style.textShadow = 'none';
                coppia.style.boxShadow = 'none';
                coppia.style.filter = 'none';
                coppia.style.border = '2px solid rgba(255,255,255,0.2)';

                // üîß RIATTIVA GLI ONCLICK
                const squadra = coppia.getAttribute('data-squadra');
                coppia.setAttribute('onclick', `selezionaCoppia('${incontroId}', '${squadra}')`);
                coppia.style.cursor = 'pointer';

                // Aggiorna anche l'overview se siamo in gestione-incontri
                if (typeof aggiornaOverviewDopoReset === 'function') {
                    aggiornaOverviewDopoReset(incontroId);
                }
            });
                        
            console.log(`[RESET UI OK] Incontro ${incontroId} pronto per nuova selezione`);
        }

        // Utility functions
        function getTeamColor(nomeColore) {
            const colori = {
                'rosso': '#ef4444', 'rossa': '#ef4444',
                'blu': '#3b82f6', 'azzurro': '#3b82f6', 'azzurra': '#3b82f6',
                'verde': '#10b981',
                'giallo': '#f59e0b', 'gialla': '#f59e0b',
                'viola': '#8b5cf6',
                'arancione': '#f97316',
                'rosa': '#ec4899',
                'marrone': '#92400e',
                'nero': '#374151', 'nera': '#374151',
                'bianco': '#f3f4f6', 'bianca': '#f3f4f6',
                'grigio': '#6b7280', 'grigia': '#6b7280',
                'smeraldo': '#10b981',
                'fucsia': '#d946ef'
            };

            const coloreKey = nomeColore?.toLowerCase?.() || 'default';
            return colori[coloreKey] || '#4299e1';
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function tornaAlMaster() {
            window.location.href = '/master';
        }

        function vaiAGestione() {
            window.location.href = '/gestione-incontri';
        }
    </script>
</body>
</html>