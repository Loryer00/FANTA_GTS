<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FantaGTS - Incontri e Risultati</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            min-height: 100vh;
            color: #e2e8f0;
            padding: 15px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(0,0,0,0.4);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .section {
            background: rgba(255,255,255,0.08);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }

            .section h2 {
                margin-bottom: 15px;
                color: #4299e1;
                border-bottom: 2px solid #4299e1;
                padding-bottom: 8px;
                font-size: 1.3em;
            }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .btn-primary {
            background: #4299e1;
            color: white;
            border-color: #4299e1;
        }

        .btn-secondary {
            background: #4a5568;
            color: #e2e8f0;
            border-color: #4a5568;
        }

        .btn-success {
            background: #48bb78;
            color: white;
            border-color: #48bb78;
        }

        .turni-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .turno-btn {
            padding: 10px 15px;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

            .turno-btn.active {
                background: #4299e1;
                border-color: #4299e1;
                color: white;
            }

            .turno-btn:hover {
                border-color: #4299e1;
            }

        .incontro-card {
            background: rgba(255,255,255,0.08);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .incontro-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(255,255,255,0.1);
        }

        .vs-title {
            font-size: 1.5em;
            font-weight: bold;
            color: #4299e1;
        }

        .incontro-status {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .status-completato {
            background: #48bb78;
            color: white;
        }

        .status-in-corso {
            background: #ed8936;
            color: white;
        }

        .partita-grid {
            display: grid;
            grid-template-columns: 1fr 150px 1fr;
            gap: 20px;
            align-items: center;
            margin-bottom: 15px;
        }

        .squadra-info {
            text-align: center;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            border: 2px solid;
        }

        .squadra-nome {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .giocatori-list {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
        }

        .giocatore-slot {
            padding: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 6px;
            font-size: 0.9em;
            text-align: center;
        }

            .giocatore-slot.vincitore {
                background: #48bb78;
                color: white;
                font-weight: bold;
            }

        .risultato-section {
            text-align: center;
            padding: 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
        }

        .risultato-inputs {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 15px 0;
            align-items: center;
        }

        .risultato-btn {
            padding: 15px 25px;
            border: 2px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

            .risultato-btn.selected {
                background: #4299e1;
                border-color: #4299e1;
                color: white;
            }

            .risultato-btn.vittoria {
                background: #48bb78;
                border-color: #48bb78;
                color: white;
            }

            .risultato-btn.sconfitta {
                background: #f56565;
                border-color: #f56565;
                color: white;
            }

        .posizioni-dettaglio {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .posizione-match {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }

            .posizione-match.completato {
                border-color: #48bb78;
            }

        .posizione-header {
            text-align: center;
            font-weight: bold;
            margin-bottom: 10px;
            color: #4299e1;
        }

        .match-players {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }

        .player-name {
            text-align: center;
            padding: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 6px;
            font-size: 0.9em;
        }

        .vs-separator {
            font-weight: bold;
            color: #f56565;
        }

        .win-buttons {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .win-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8em;
            font-weight: bold;
            transition: all 0.3s ease;
        }

            .win-btn.win {
                background: #48bb78;
                color: white;
            }

            .win-btn.lose {
                background: #f56565;
                color: white;
            }

            .win-btn:hover {
                transform: translateY(-2px);
            }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            z-index: 1001;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

            .notification.show {
                transform: translateX(0);
            }

            .notification.success {
                background: #48bb78;
            }

            .notification.error {
                background: #f56565;
            }

        /* Nuovi stili per interfaccia compatta */
        .incontro-card-live {
            background: rgba(255,255,255,0.08);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .incontro-header-live {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .coppia-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .coppia-numero {
            font-weight: bold;
            font-size: 1.1em;
            color: #4299e1;
        }

        .posizioni {
            font-size: 0.9em;
            opacity: 0.8;
            color: #48bb78;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }

            .status-badge.completato {
                background: rgba(72, 187, 120, 0.2);
                color: #48bb78;
                border: 1px solid rgba(72, 187, 120, 0.3);
            }

            .status-badge.in-attesa {
                background: rgba(237, 137, 54, 0.2);
                color: #ed8936;
                border: 1px solid rgba(237, 137, 54, 0.3);
            }

        .giocatori-grid-live {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .giocatore-confronto {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 12px;
        }

        .pos-label {
            text-align: center;
            font-weight: bold;
            color: #4299e1;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .giocatore-vs {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .giocatore-btn {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            color: white;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9em;
            min-width: 100px;
        }

            .giocatore-btn:hover {
                background: rgba(66, 153, 225, 0.3);
                border-color: #4299e1;
                transform: scale(1.05);
            }

            .giocatore-btn.vincitore {
                background: rgba(72, 187, 120, 0.4);
                border-color: #48bb78;
                color: #fff;
                font-weight: bold;
            }

        .vs-small {
            color: #f56565;
            font-weight: bold;
            font-size: 0.9em;
        }

        .azioni-live {
            display: flex;
            gap: 10px;
            justify-content: center;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .btn-completa, .btn-reset {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s ease;
        }

        .btn-completa {
            background: #48bb78;
            color: white;
        }

            .btn-completa:disabled {
                background: #4a5568;
                cursor: not-allowed;
                opacity: 0.6;
            }

        .btn-reset {
            background: #ed8936;
            color: white;
        }

        .btn-completa:hover:not(:disabled) {
            background: #38a169;
            transform: translateY(-1px);
        }

        .btn-reset:hover {
            background: #dd6b20;
            transform: translateY(-1px);
        }

        /* Stili per i gruppi di scontri */
        .gruppo-scontro-header {
            background: linear-gradient(135deg, rgba(66, 153, 225, 0.2), rgba(72, 187, 120, 0.2));
            border-radius: 12px;
            padding: 15px;
            margin: 20px 0 10px 0;
            border: 2px solid rgba(66, 153, 225, 0.3);
        }

        .squadre-vs {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }

        .squadra-nome {
            padding: 8px 16px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .vs-text {
            font-size: 1.2em;
            font-weight: bold;
            color: #f56565;
        }

        .gruppo-incontri {
            margin-bottom: 30px;
        }

        /* Stili per le coppie */
        .coppie-confronto {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .coppia-btn {
            flex: 1;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
        }

            .coppia-btn:hover {
                background: rgba(66, 153, 225, 0.2);
                border-color: #4299e1;
                transform: scale(1.02);
            }

            .coppia-btn.vincitore {
                background: rgba(72, 187, 120, 0.3);
                border-color: #48bb78;
                box-shadow: 0 0 15px rgba(72, 187, 120, 0.4);
            }

        .coppia-giocatori {
            margin-bottom: 10px;
        }

        .giocatore {
            font-size: 0.9em;
            margin: 2px 0;
            font-weight: 500;
        }

        .squadra-label {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
            color: white;
            text-align: center;
        }

        .vs-divider {
            font-size: 1.5em;
            font-weight: bold;
            color: #f56565;
            flex-shrink: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèüÔ∏è FantaGTS - Incontri e Risultati</h1>
            <p>Visualizza gli incontri e inserisci i risultati delle partite</p>
            <div style="margin-top: 15px;">
                <button class="btn btn-secondary" onclick="tornaAlMaster()">
                    ‚Üê Torna al Master
                </button>
                <button class="btn btn-primary" onclick="vaiAGestione()">
                    ‚öôÔ∏è Gestione Incontri
                </button>
            </div>
        </div>

        <!-- Selezione Turno -->
        <div class="section">
            <h2>üìÖ Seleziona Turno</h2>
            <div id="turniSelector" class="turni-selector">
                <!-- I turni verranno caricati qui -->
            </div>
        </div>

        <!-- Incontri del Turno -->
        <div class="section" id="incontriSection" style="display: none;">
            <h2>üèÜ Incontri - <span id="turnoSelezionatoNome">Turno</span></h2>
            <div id="incontriContainer">
                <!-- Gli incontri verranno caricati qui -->
            </div>
        </div>
    </div>

    <script>
        let turni = [];
        let turnoSelezionato = null;
        let incontriTurno = [];
        let incontriCaricati = [];
        let squadreDisponibili = [];
        let coppieVincenti = new Map();
        let risultatiSelezionati = new Map();

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', () => {
            caricaSquadre();
            caricaTurni();
        });

        // Carica squadre del circolo
        async function caricaSquadre() {
            try {
                const response = await fetch('/api/squadre');
                squadreDisponibili = await response.json();
            } catch (error) {
                console.error('Errore caricamento squadre:', error);
            }
        }

        // Carica turni disponibili
        async function caricaTurni() {
            try {
                const response = await fetch('/api/turni');
                turni = await response.json();

                const container = document.getElementById('turniSelector');
                container.innerHTML = '';

                if (turni.length === 0) {
                    container.innerHTML = '<p>Nessun turno configurato</p>';
                    return;
                }

                turni.forEach(turno => {
                    const btn = document.createElement('div');
                    btn.className = 'turno-btn';
                    btn.textContent = `Turno ${turno.turno_numero}: ${turno.nome_turno}`;
                    btn.onclick = () => selezionaTurno(turno);
                    container.appendChild(btn);
                });

            } catch (error) {
                console.error('Errore caricamento turni:', error);
                showNotification('Errore caricamento turni', 'error');
            }
        }

        // Seleziona turno
        async function selezionaTurno(turno) {
            // Aggiorna UI selezione
            document.querySelectorAll('.turno-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            turnoSelezionato = turno;
            document.getElementById('turnoSelezionatoNome').textContent = `${turno.nome_turno}`;

            // Carica incontri del turno
            await caricaIncontriTurno(turno.id);

            document.getElementById('incontriSection').style.display = 'block';
            document.getElementById('incontriSection').scrollIntoView({ behavior: 'smooth' });
        }

        // Carica incontri del turno selezionato
        async function caricaIncontriTurno(turnoId) {
            try {
                const response = await fetch(`/api/incontri-turno/${turnoId}`);
                incontriCaricati = await response.json();

                const container = document.getElementById('incontriContainer');
                container.innerHTML = '';

                if (incontriCaricati.length === 0) {
                    container.innerHTML = '<p>Nessun incontro generato per questo turno. Vai alla gestione incontri per crearli.</p>';
                    return;
                }

                // Raggruppa incontri per scontro tra squadre
                const incontriRaggruppati = {};

                incontriCaricati.forEach(incontro => {
                    const squadra1 = squadreDisponibili.find(s => s.numero === incontro.squadra1);
                    const squadra2 = squadreDisponibili.find(s => s.numero === incontro.squadra2);

                    const chiaveGruppo = `${squadra1?.colore || 'Sconosciuta'}_vs_${squadra2?.colore || 'Sconosciuta'}`;

                    if (!incontriRaggruppati[chiaveGruppo]) {
                        incontriRaggruppati[chiaveGruppo] = {
                            squadra1: squadra1,
                            squadra2: squadra2,
                            incontri: []
                        };
                    }

                    incontriRaggruppati[chiaveGruppo].incontri.push(incontro);
                });

                // Crea HTML per ogni gruppo
                for (const [chiaveGruppo, gruppo] of Object.entries(incontriRaggruppati)) {
                    // Header del gruppo
                    const gruppoHeader = document.createElement('div');
                    gruppoHeader.className = 'gruppo-scontro-header';
                    gruppoHeader.innerHTML = `
                <div class="squadre-vs">
                    <span class="squadra-nome" style="background-color: ${getTeamColor(gruppo.squadra1?.colore)};">
                        ${gruppo.squadra1?.colore?.toUpperCase() || 'SQUADRA 1'}
                    </span>
                    <span class="vs-text">VS</span>
                    <span class="squadra-nome" style="background-color: ${getTeamColor(gruppo.squadra2?.colore)};">
                        ${gruppo.squadra2?.colore?.toUpperCase() || 'SQUADRA 2'}
                    </span>
                </div>
            `;
                    container.appendChild(gruppoHeader);

                    // Container per gli incontri del gruppo
                    const gruppoContainer = document.createElement('div');
                    gruppoContainer.className = 'gruppo-incontri';

                    // Carica ogni incontro del gruppo
                    for (const incontro of gruppo.incontri) {
                        const incontroCard = await creaCardIncontro(incontro);
                        gruppoContainer.appendChild(incontroCard);
                    }

                    container.appendChild(gruppoContainer);
                }

            } catch (error) {
                console.error('Errore caricamento incontri:', error);
                showNotification('Errore caricamento incontri', 'error');
            }
        }

        // Crea card per un incontro
        async function creaCardIncontro(incontro) {
            const card = document.createElement('div');
            card.className = 'incontro-card-live';
            card.setAttribute('data-incontro-id', incontro.id);

            const squadra1 = squadreDisponibili.find(s => s.numero === incontro.squadra1);
            const squadra2 = squadreDisponibili.find(s => s.numero === incontro.squadra2);

            if (!squadra1 || !squadra2) {
                card.innerHTML = '<p>Errore: squadre non trovate</p>';
                return card;
            }

            card.innerHTML = `
        <div class="incontro-header-live">
            <div class="coppia-info">
                <span class="coppia-numero">Coppia ${incontro.coppia_numero}</span>
                <span class="posizioni">${incontro.pos1} + ${incontro.pos2}</span>
            </div>
            <span class="status-badge ${incontro.completato ? 'completato' : 'in-attesa'}">
                ${incontro.completato ? '‚úÖ Completato' : '‚è≥ In attesa'}
            </span>
        </div>
        
        <div class="coppie-confronto">
            <button class="coppia-btn" data-squadra="1" onclick="selezionaCoppia('${incontro.id}', 1)">
                <div class="coppia-giocatori">
                    <div class="giocatore">${getNomeGiocatore(squadra1, incontro.pos1)} (${incontro.pos1})</div>
                    <div class="giocatore">${getNomeGiocatore(squadra1, incontro.pos2)} (${incontro.pos2})</div>
                </div>
                <div class="squadra-label" style="background-color: ${getTeamColor(squadra1.colore)};">
                    ${squadra1.colore.toUpperCase()}
                </div>
            </button>
            
            <div class="vs-divider">VS</div>
            
            <button class="coppia-btn" data-squadra="2" onclick="selezionaCoppia('${incontro.id}', 2)">
                <div class="coppia-giocatori">
                    <div class="giocatore">${getNomeGiocatore(squadra2, incontro.pos1)} (${incontro.pos1})</div>
                    <div class="giocatore">${getNomeGiocatore(squadra2, incontro.pos2)} (${incontro.pos2})</div>
                </div>
                <div class="squadra-label" style="background-color: ${getTeamColor(squadra2.colore)};">
                    ${squadra2.colore.toUpperCase()}
                </div>
            </button>
        </div>
        
        <div class="azioni-live">
            <button class="btn-completa" onclick="completaIncontro('${incontro.id}')"
                    ${incontro.completato ? 'disabled' : ''}>
                ${incontro.completato ? 'Completato' : 'Completa Incontro'}
            </button>
            <button class="btn-reset" onclick="resetIncontro('${incontro.id}')">
                Reset
            </button>
        </div>
    `;

            return card;
        }

        function getNomeGiocatore(squadra, posizione) {
            const pos = posizione.toLowerCase();
            return squadra[pos] || `${posizione} Non Trovato`;
        }

        function getRisultatoClass(incontroId, posizione, squadra) {
            // Questa funzione restituir√† 'vincitore' se il giocatore ha vinto
            // Per ora restituisce stringa vuota, implementeremo la logica dopo
            return '';
        }

        // Crea dettagli incontro con grid delle posizioni
        async function creaDettagliIncontro(incontro, squadra1, squadra2, dettagliEsistenti) {
            const posizioni = [incontro.pos1, incontro.pos2];
            const teamColor1 = getTeamColor(squadra1.colore);
            const teamColor2 = getTeamColor(squadra2.colore);

            let html = '<div class="posizioni-dettaglio">';

            for (const pos of posizioni) {
                const giocatore1 = squadra1[pos.toLowerCase()] || 'N/A';
                const giocatore2 = squadra2[pos.toLowerCase()] || 'N/A';

                // Cerca dettaglio esistente per questa posizione
                const dettaglio = dettagliEsistenti.find(d => d.posizione === pos);
                const vincitore = dettaglio ? dettaglio.vincitore : 0;

                html += `
                        <div class="posizione-match ${dettaglio ? 'completato' : ''}">
                            <div class="posizione-header">${pos}</div>
                            <div class="match-players">
                                <div class="player-name" style="border-color: ${teamColor1}; ${vincitore === 1 ? 'background: #48bb78; color: white; font-weight: bold;' : ''}">
                                    ${giocatore1}
                                </div>
                                <div class="vs-separator">VS</div>
                                <div class="player-name" style="border-color: ${teamColor2}; ${vincitore === 2 ? 'background: #48bb78; color: white; font-weight: bold;' : ''}">
                                    ${giocatore2}
                                </div>
                            </div>
                            ${!incontro.completato ? `
                                <div class="win-buttons">
                                    <button class="win-btn ${vincitore === 1 ? 'win' : ''}"
                                            onclick="setVincitore(${incontro.id}, '${pos}', 1, '${giocatore1}', '${giocatore2}')">
                                        Vince ${squadra1.colore}
                                    </button>
                                    <button class="win-btn ${vincitore === 2 ? 'win' : ''}"
                                            onclick="setVincitore(${incontro.id}, '${pos}', 2, '${giocatore1}', '${giocatore2}')">
                                        Vince ${squadra2.colore}
                                    </button>
                                </div>
                            ` : `
                                <div style="text-align: center; margin-top: 10px; font-weight: bold; color: #48bb78;">
                                    Vince: ${vincitore === 1 ? squadra1.colore : vincitore === 2 ? squadra2.colore : 'Pareggio'}
                                </div>
                            `}
                        </div>
                    `;
            }

            html += '</div>';

            // Aggiungi pulsanti di controllo se non completato
            if (!incontro.completato) {
                html += `
                        <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 2px solid rgba(255,255,255,0.1);">
                            <button class="btn btn-success" onclick="completaIncontro(${incontro.id})">
                                ‚úÖ Completa Incontro
                            </button>
                            <button class="btn btn-secondary" onclick="resetIncontro(${incontro.id})">
                                üîÑ Reset Risultati
                            </button>
                        </div>
                    `;
            }

            return html;
        }

        // Imposta vincitore per una posizione
        async function setVincitore(incontroId, posizione, vincitore, giocatore1, giocatore2) {
            try {
                const response = await fetch('/api/set-vincitore', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        incontro_id: incontroId,
                        posizione: posizione,
                        vincitore: vincitore,
                        giocatore_squadra1: giocatore1,
                        giocatore_squadra2: giocatore2,
                        punti_assegnati: turnoSelezionato.punti_vittoria
                    })
                });

                if (response.ok) {
                    showNotification(`Vincitore impostato per ${posizione}`, 'success');
                    // Ricarica l'incontro
                    await caricaIncontriTurno(turnoSelezionato.id);
                } else {
                    const error = await response.json();
                    showNotification('Errore: ' + error.error, 'error');
                }
            } catch (error) {
                showNotification('Errore di connessione', 'error');
            }
        }

        // 2. FUNZIONE selezionaCoppia (aggiungere prima di completaIncontro)
        function selezionaCoppia(incontroId, squadra) {
            // Salva la selezione
            coppieVincenti.set(incontroId, squadra);

            // Trova la card dell'incontro
            const card = document.querySelector(`[data-incontro-id="${incontroId}"]`);
            if (!card) return;

            // Rimuovi selezione da entrambe le coppie
            const allButtons = card.querySelectorAll('.coppia-btn');
            allButtons.forEach(btn => btn.classList.remove('vincitore'));

            // Aggiungi selezione alla coppia cliccata
            const selectedButton = card.querySelector(`[data-squadra="${squadra}"]`);
            if (selectedButton) {
                selectedButton.classList.add('vincitore');
            }

            console.log(`[SELEZIONE] Squadra ${squadra} selezionata per incontro ${incontroId}`);
        }

        // 3. FUNZIONE selezionaVincitore (aggiungere se serve per compatibilit√†)
        function selezionaVincitore(incontroId, posizione, squadra) {
            const key = `${incontroId}_${posizione}`;
            risultatiSelezionati.set(key, squadra);

            // Aggiorna visualmente i bottoni
            const container = document.querySelector(`[data-incontro-id="${incontroId}"]`);
            if (!container) return;

            const posizioneContainer = container.querySelector(`[data-pos="${posizione}"]`);
            if (!posizioneContainer) return;

            // Rimuovi classe vincitore da tutti i bottoni della posizione
            posizioneContainer.querySelectorAll('.giocatore-btn').forEach(btn => {
                btn.classList.remove('vincitore');
            });

            // Aggiungi classe vincitore al bottone cliccato
            const bottoneCliccato = posizioneContainer.querySelector(`[onclick*="'${squadra}'"]`);
            if (bottoneCliccato) {
                bottoneCliccato.classList.add('vincitore');
            }

            showNotification(`Selezionato vincitore per ${posizione}`, 'success');
        }

        // 4. FUNZIONE getRisultatoClass (per compatibilit√†)
        function getRisultatoClass(incontroId, posizione, squadra) {
            // Questa funzione restituir√† 'vincitore' se il giocatore ha vinto
            // Per ora restituisce stringa vuota
            return '';
        }

        // FUNZIONE completaIncontro CHE FUNZIONA CON selezionaCoppia (SISTEMA ORIGINALE)
        async function completaIncontro(incontroId) {
            console.log('[INIZIO] Tentativo di completare incontro ID:', incontroId);

            // Controllo se l'incontro √® gi√† completato
            const incontroContainer = document.querySelector(`[data-incontro-id="${incontroId}"]`);
            if (incontroContainer && (incontroContainer.querySelector('.completato-badge') ||
                incontroContainer.querySelector('.status-badge.completato'))) {
                console.log('[BLOCCO] Incontro gi√† completato');
                showNotification('Questo incontro √® gi√† stato completato!', 'warning');
                return;
            }

            if (!confirm('Completare questo incontro? Non sar√† pi√π possibile modificarlo.')) {
                console.log('[ANNULLATO] Utente ha annullato il completamento');
                return;
            }

            try {
                // SISTEMA ORIGINALE: Verifica squadra selezionata con coppieVincenti
                const squadraSelezionata = coppieVincenti.get(incontroId) ||
                    coppieVincenti.get(parseInt(incontroId)) ||
                    coppieVincenti.get(incontroId.toString());

                console.log('[CHECK] Squadra selezionata:', squadraSelezionata);

                if (!squadraSelezionata) {
                    console.log('[ERRORE] Nessuna squadra selezionata');
                    showNotification('Seleziona prima una squadra vincente!', 'error');
                    return;
                }

                // Trova l'incontro corrente per ottenere le posizioni
                const incontroCorrente = incontriCaricati.find(i => i.id == incontroId);
                if (!incontroCorrente) {
                    throw new Error('Incontro non trovato nei dati caricati');
                }

                console.log('[STEP 1] Incontro trovato:', incontroCorrente);

                // Trova le squadre per ottenere i nomi dei giocatori
                const squadra1 = squadreDisponibili.find(s => s.numero === incontroCorrente.squadra1);
                const squadra2 = squadreDisponibili.find(s => s.numero === incontroCorrente.squadra2);

                if (!squadra1 || !squadra2) {
                    throw new Error('Squadre non trovate');
                }

                console.log('[STEP 2] Squadre trovate:', squadra1.colore, 'vs', squadra2.colore);

                const posizioni = [incontroCorrente.pos1, incontroCorrente.pos2];

                // SISTEMA AUTOMATICO: Imposta vincitori per tutte le posizioni basandosi sulla squadra selezionata
                console.log('[STEP 3] Impostazione automatica vincitori per posizioni:', posizioni);

                for (const posizione of posizioni) {
                    const giocatore1 = squadra1[posizione.toLowerCase()] || 'N/A';
                    const giocatore2 = squadra2[posizione.toLowerCase()] || 'N/A';

                    const requestData = {
                        incontro_id: incontroId,
                        posizione: posizione,
                        vincitore: squadraSelezionata, // 1 o 2
                        giocatore_squadra1: giocatore1,
                        giocatore_squadra2: giocatore2,
                        punti_assegnati: turnoSelezionato?.punti_vittoria || 1
                    };

                    console.log(`[API] Impostazione vincitore per ${posizione}:`, requestData);

                    const response = await fetch('/api/set-vincitore', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestData)
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        console.log(`[ERRORE] Errore set-vincitore per ${posizione}:`, error);
                        showNotification(`Errore impostazione vincitore ${posizione}: ` + error.error, 'error');
                        return;
                    }

                    console.log(`[SUCCESSO] Vincitore impostato per ${posizione}`);
                }

                console.log('[STEP 4] Tutti i vincitori impostati, completando incontro...');

                // Completa l'incontro
                const completaResponse = await fetch(`/api/completa-incontro/${incontroId}`, {
                    method: 'POST'
                });

                if (completaResponse.ok) {
                    const result = await completaResponse.json();
                    console.log('[SUCCESSO] Incontro completato:', result);

                    showNotification(
                        `Incontro completato! ${result.risultato} (${result.vittorie_squadra1}-${result.vittorie_squadra2})`,
                        'success'
                    );

                    // AGGIORNAMENTO UI IMMEDIATO CON DEBUG
                    if (incontroContainer) {
                        console.log('[DEBUG] Container trovato:', incontroContainer);

                        // 1. Aggiorna status badge
                        const statusBadge = incontroContainer.querySelector('.status-badge');
                        console.log('[DEBUG] Status badge trovato:', statusBadge);
                        if (statusBadge) {
                            statusBadge.className = 'status-badge completato';
                            statusBadge.innerHTML = '‚úÖ COMPLETATO';
                            statusBadge.style.background = 'rgba(72, 187, 120, 0.8)';
                            statusBadge.style.color = 'white';
                        }

                        // 2. Disabilita pulsante completa - selettori multipli
                        const completaBtn = incontroContainer.querySelector(`[onclick*="completaIncontro(${incontroId})"]`) ||
                            incontroContainer.querySelector('.btn-completa') ||
                            incontroContainer.querySelector(`button[onclick*="${incontroId}"]`);
                        console.log('[DEBUG] Pulsante completa trovato:', completaBtn);
                        if (completaBtn) {
                            completaBtn.textContent = 'Completato';
                            completaBtn.disabled = true;
                            completaBtn.style.backgroundColor = '#48bb78 !important';
                            completaBtn.style.color = 'white !important';
                            completaBtn.style.cursor = 'not-allowed';
                            completaBtn.removeAttribute('onclick');
                            completaBtn.setAttribute('onclick', 'return false;');
                        }

                        // 3. Disabilita pulsanti selezione squadre
                        const coppiaBtns = incontroContainer.querySelectorAll('.coppia-btn');
                        console.log('[DEBUG] Pulsanti coppia trovati:', coppiaBtns.length);
                        coppiaBtns.forEach((btn, index) => {
                            console.log(`[DEBUG] Disabilitando pulsante ${index + 1}`);
                            btn.style.pointerEvents = 'none';
                            btn.style.opacity = '0.6';
                            btn.style.filter = 'grayscale(50%)';
                            btn.style.cursor = 'not-allowed';
                            btn.removeAttribute('onclick');
                            btn.classList.remove('vincitore');
                        });

                        // 4. Aggiorna bordi e sfondo
                        incontroContainer.style.border = '2px solid #48bb78';
                        incontroContainer.style.background = 'rgba(72, 187, 120, 0.1)';
                        incontroContainer.style.transition = 'all 0.3s ease';

                        // 5. Aggiungi classe completato per CSS
                        incontroContainer.classList.add('incontro-completato');

                        console.log('[UI] Interfaccia aggiornata immediatamente - MIGLIORATA');
                    } else {
                        console.error('[ERROR] Container incontro non trovato per ID:', incontroId);
                    }

                    // Pulizia memoria
                    coppieVincenti.delete(incontroId);
                    coppieVincenti.delete(parseInt(incontroId));
                    coppieVincenti.delete(incontroId.toString());

                    console.log('[STEP 5] Completamento terminato con successo');

                } else {
                    const error = await completaResponse.json();
                    console.log('[ERRORE] Completamento fallito:', error);
                    showNotification('Errore completamento: ' + error.error, 'error');
                }

            } catch (generalError) {
                console.error('[ERRORE] Errore generale:', generalError);
                showNotification('Errore di connessione: ' + generalError.message, 'error');
            }

            console.log('[FINE] Processo completamento terminato per incontro', incontroId);
        }

        // Reset incontro
        async function resetIncontro(incontroId) {
            if (!confirm('Resettare tutti i risultati di questo incontro?')) return;

            try {
                const response = await fetch(`/api/reset-incontro/${incontroId}`, {
                    method: 'POST'
                });

                if (response.ok) {
                    showNotification('Incontro resettato', 'success');
                    await caricaIncontriTurno(turnoSelezionato.id);
                } else {
                    const error = await response.json();
                    showNotification('Errore: ' + error.error, 'error');
                }
            } catch (error) {
                showNotification('Errore di connessione', 'error');
            }
        }

        // Utility functions
        function getTeamColor(nomeColore) {
            const colori = {
                'rosso': '#ef4444', 'rossa': '#ef4444',
                'blu': '#3b82f6', 'azzurro': '#3b82f6', 'azzurra': '#3b82f6',
                'verde': '#10b981',
                'giallo': '#f59e0b', 'gialla': '#f59e0b',
                'viola': '#8b5cf6',
                'arancione': '#f97316',
                'rosa': '#ec4899',
                'marrone': '#92400e',
                'nero': '#374151', 'nera': '#374151',
                'bianco': '#f3f4f6', 'bianca': '#f3f4f6',
                'grigio': '#6b7280', 'grigia': '#6b7280',
                'smeraldo': '#10b981',
                'fucsia': '#d946ef'
            };

            const coloreKey = nomeColore?.toLowerCase?.() || 'default';
            return colori[coloreKey] || '#4299e1';
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function tornaAlMaster() {
            window.location.href = '/master';
        }

        function vaiAGestione() {
            window.location.href = '/gestione-incontri';
        }
    </script>
</body>
</html>