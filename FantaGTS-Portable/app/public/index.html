<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FantaGTS - Partecipante</title>

    <!-- PWA Configuration -->
    <meta name="theme-color" content="#4299e1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FantaGTS">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FantaGTS">

    <!-- Manifest -->
    <link rel="manifest" href="/manifest.json">

    <!-- iOS Icons -->
    <link rel="apple-touch-icon" href="/icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="167x167" href="/icons/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/icon-192x192.png">

    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/icon-72x72.png">

    <script src="/socket.io/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            min-height: 100vh;
            color: #e2e8f0;
            padding: 10px;
        }

        .container {
            max-width: 450px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            padding: 20px 0;
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .registration-form {
            background: rgba(255,255,255,0.08);
            padding: 25px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .input-group {
            margin-bottom: 15px;
        }

            .input-group label {
                display: block;
                margin-bottom: 5px;
                font-weight: bold;
                color: #cbd5e0;
            }

            .input-group input {
                width: 100%;
                padding: 15px;
                border: none;
                border-radius: 10px;
                background: rgba(255,255,255,0.95);
                color: #2d3748;
                font-size: 1.1em;
                text-align: center;
                border: 1px solid rgba(255,255,255,0.2);
            }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 0;
        }

        .btn-primary {
            background: #4299e1;
            color: white;
            border: 1px solid #4299e1;
        }

            .btn-primary:hover {
                background: #3182ce;
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(66, 153, 225, 0.4);
            }

        .section {
            background: rgba(255,255,255,0.08);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255,255,255,0.08);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .connection-status {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .status-connected {
            background: rgba(72, 187, 120, 0.2);
            border: 2px solid #48bb78;
            color: #68d391;
        }

        .status-waiting {
            background: rgba(237, 137, 54, 0.2);
            border: 2px solid #ed8936;
            color: #f6ad55;
        }

        .round-info {
            background: rgba(245, 101, 101, 0.2);
            border: 3px solid #f56565;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 20px;
        }

        .big-timer {
            font-size: 3em;
            font-weight: bold;
            color: #4299e1;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            margin: 15px 0;
        }

        .players-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .player-card {
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
            color: #e2e8f0;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }

            .player-card:hover {
                transform: translateY(-3px);
                box-shadow: 0 8px 25px rgba(0,0,0,0.4);
                border-color: #4299e1;
            }

            .player-card.selected {
                border-color: #4299e1;
                background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
                color: white;
            }

        .player-name {
            font-weight: bold;
            margin-bottom: 8px;
        }

        .team-color-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin: 0 auto 8px;
            border: 2px solid white;
        }

        .bid-section {
            background: rgba(255,255,255,0.08);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .selected-player-info {
            background: rgba(72, 187, 120, 0.2);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 15px;
            border: 2px solid #48bb78;
            color: #68d391;
        }

        .bid-input {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            background: rgba(255,255,255,0.95);
            color: #2d3748;
            font-size: 1.3em;
            text-align: center;
            font-weight: bold;
            margin-bottom: 15px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .confirm-bid {
            width: 100%;
            padding: 15px;
            background: #f56565;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            border: 1px solid #f56565;
        }

            .confirm-bid:disabled {
                background: #4a5568;
                cursor: not-allowed;
                border-color: #4a5568;
            }

        .my-team {
            background: rgba(255,255,255,0.08);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .team-slots {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            margin-top: 15px;
        }

        .team-slot {
            background: rgba(255,255,255,0.08);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid transparent;
            min-height: 60px;
        }

            .team-slot.filled {
                background: rgba(72, 187, 120, 0.2);
                border: 4px solid #48bb78;
                color: #68d391;
                font-weight: bold;
                text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
                min-height: 70px;
            }

                .team-slot.filled small {
                    font-weight: normal;
                    opacity: 0.8;
                }

            .team-slot.empty {
                background: rgba(74, 85, 104, 0.3);
                border-color: #4a5568;
                opacity: 0.7;
                color: #a0aec0;
            }

        @media (max-width: 480px) {
            .players-grid {
                grid-template-columns: 1fr;
            }

            .big-timer {
                font-size: 2.5em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéæ FantaGTS</h1>
            <p>Fantasy Tennis del Circolo</p>
        </div>

        <!-- Registrazione -->
        <div id="registration-area">
            <div class="registration-form">
                <h2>üëã Benvenuto!</h2>
                <p style="margin-bottom: 20px;">Inserisci i tuoi dati per partecipare al FantaGTS</p>

                <div class="input-group">
                    <label>Il tuo nome:</label>
                    <input type="text" id="playerName" placeholder="Lorenzo Buselli" autocomplete="name">
                </div>

                <div class="input-group">
                    <label>Email (opzionale):</label>
                    <input type="email" id="playerEmail" placeholder="lorenzo@email.com" autocomplete="email">
                </div>

                <div class="input-group">
                    <label>Telefono (opzionale):</label>
                    <input type="tel" id="playerPhone" placeholder="333-1234567" autocomplete="tel">
                </div>

                <button class="btn btn-primary" onclick="registerPlayer()">
                    üöÄ Entra nel FantaGTS
                </button>
            </div>
        </div>

        <!-- Area di gioco -->
        <div id="game-area" style="display: none;">
            <!-- Stato connessione -->
            <div id="connectionStatus" class="connection-status status-connected">
                ‚úÖ Connesso al FantaGTS
            </div>

            <!-- Info utente -->
            <div class="user-info">
                <div>
                    <strong id="currentPlayer">--</strong>
                </div>
                <div>
                    üí∞ <span id="playerCredits">2000</span> crediti
                </div>
            </div>

            <!-- Pulsante logout -->
            <div style="text-align: center; margin-bottom: 15px;">
                <button onclick="logout()" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: #e2e8f0; padding: 8px 15px; border-radius: 6px; font-size: 0.9em; cursor: pointer;">
                    üö™ Cambia Utente
                </button>
            </div>

            <!-- Attesa round -->
            <div id="waiting-phase" class="section" style="display: none;">
                <h2>‚è≥ In Attesa</h2>
                <p>Il Master avvier√† il prossimo round quando tutti sono pronti.</p>
                <p><strong>Prossimo round: <span id="nextRound">M1</span></strong></p>
            </div>

            <!-- Round attivo -->
            <div id="bidding-phase" style="display: none;">
                <div class="round-info">
                    <div style="font-size: 1.5em; font-weight: bold; margin-bottom: 10px;">
                        Round <span id="currentRound">M1</span>
                    </div>
                    <div id="offersStatus" class="big-timer">
                        Waiting...
                    </div>
                    <p id="offersMessage">In attesa che tutti facciano le loro offerte</p>
                </div>

                <!-- Griglia giocatori -->
                <div class="players-grid" id="playersGrid">
                    <!-- I giocatori verranno caricati qui -->
                </div>

                <!-- Sezione puntata -->
                <div id="bidSection" class="bid-section" style="display: none;">
                    <div id="selectedPlayerInfo" class="selected-player-info">
                        <strong>Nessun giocatore selezionato</strong>
                    </div>

                    <!-- Sezione crediti -->
                    <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; margin-bottom: 10px; text-align: center;">
                        <strong>üí∞ Crediti disponibili: <span id="creditsDisplay">2000</span></strong>
                    </div>

                    <input type="number" class="bid-input" id="bidAmount" placeholder="Inserisci quanto vuoi puntare" min="1">

                    <button class="confirm-bid" id="confirmBidBtn" onclick="confirmBid()" disabled>
                        Conferma Puntata
                    </button>
                </div>
            </div>

            <!-- La mia squadra -->
            <div class="my-team">
                <h2>üèÜ La Mia Squadra</h2>
                <div id="myTeamStats">
                    <p>Giocatori: <span id="teamCount">0</span>/10 | Punti: <span id="teamPoints">0</span></p>
                </div>
                <div class="team-slots" id="teamSlots">
                    <div class="team-slot empty" data-position="M1"><strong>M1</strong><br>-</div>
                    <div class="team-slot empty" data-position="M2"><strong>M2</strong><br>-</div>
                    <div class="team-slot empty" data-position="M3"><strong>M3</strong><br>-</div>
                    <div class="team-slot empty" data-position="M4"><strong>M4</strong><br>-</div>
                    <div class="team-slot empty" data-position="M5"><strong>M5</strong><br>-</div>
                    <div class="team-slot empty" data-position="M6"><strong>M6</strong><br>-</div>
                    <div class="team-slot empty" data-position="M7"><strong>M7</strong><br>-</div>
                    <div class="team-slot empty" data-position="F1"><strong>F1</strong><br>-</div>
                    <div class="team-slot empty" data-position="F2"><strong>F2</strong><br>-</div>
                    <div class="team-slot empty" data-position="F3"><strong>F3</strong><br>-</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variabili globali
        let socket;
        let playerData = {
            registered: false,
            name: '',
            id: '',
            credits: 2000
        };

        // SISTEMA DI PERSISTENZA CONNESSIONE AVANZATO
        let connectionPersistence = {
            wakeLock: null,
            heartbeatInterval: null,
            reconnectAttempts: 0,
            maxReconnectAttempts: 50,
            isReconnecting: false,
            lastServerResponse: Date.now()
        };

        // NUOVO: Chiavi per localStorage
        const STORAGE_KEYS = {
            PLAYER_DATA: 'fantagts_player_data',
            REGISTRATION_TIME: 'fantagts_registration_time'
        };

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', () => {
            console.log('FantaGTS Client caricato');

            // Controlla se esiste una sessione salvata
            checkExistingSession();

            // Tenta connessione socket
            try {
                initializeSocket();
            } catch (error) {
                console.log('Socket.io non disponibile, modalit√† base attiva');
            }
        });

        // Funzione per mantenere persistente la connessione
        async function startConnectionPersistence() {
            console.log('üîó Avviando sistema di persistenza PWA...');

            // 1. Wake Lock con gestione errori migliorata
            try {
                if ('wakeLock' in navigator) {
                    connectionPersistence.wakeLock = await navigator.wakeLock.request('screen');
                    console.log('‚úÖ Wake Lock attivato');

                    // Riattiva wake lock quando la pagina diventa visibile
                    document.addEventListener('visibilitychange', async () => {
                        if (document.visibilityState === 'visible' && connectionPersistence.wakeLock?.released) {
                            connectionPersistence.wakeLock = await navigator.wakeLock.request('screen');
                            console.log('üîÑ Wake Lock riattivato');
                        }
                    });
                }
            } catch (err) {
                console.log('‚ö†Ô∏è Wake Lock non disponibile:', err.message);
            }

            // 2. Heartbeat con strategia PWA
            connectionPersistence.heartbeatInterval = setInterval(() => {
                maintainConnectionPWA();
            }, document.visibilityState === 'visible' ? 3000 : 1500);

            // 3. Service Worker per background processing
            if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                // Invia messaggi periodici al SW per mantenerlo attivo
                setInterval(() => {
                    navigator.serviceWorker.controller.postMessage({
                        type: 'KEEP_ALIVE',
                        timestamp: Date.now(),
                        playerData: {
                            name: playerData.name,
                            credits: playerData.credits
                        }
                    });
                }, 10000);
            }

            // 4. Background Sync per azioni offline
            if ('serviceWorker' in navigator && 'sync' in window.ServiceWorkerRegistration.prototype) {
                navigator.serviceWorker.ready.then(registration => {
                    console.log('‚úÖ Background Sync disponibile');
                });
            }

            // 5. Push Notifications (se supportate)
            if ('Notification' in window && 'serviceWorker' in navigator) {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    console.log('‚úÖ Notifiche push autorizzate');
                    subscribeToPushNotifications();
                }
            }

            // 6. Network state listeners migliorati
            setupNetworkListeners();

            console.log('‚úÖ Sistema di persistenza PWA completo attivato');
        }

        // AGGIUNGI queste nuove funzioni:
        function maintainConnectionPWA() {
            if (!socket) {
                attemptReconnection();
                return;
            }

            if (socket.connected) {
                // Connesso: invia heartbeat con pi√π dati
                socket.emit('heartbeat', {
                    timestamp: Date.now(),
                    type: 'pwa_persistence',
                    visibilityState: document.visibilityState,
                    onLine: navigator.onLine,
                    credits: playerData.credits
                });
                connectionPersistence.reconnectAttempts = 0;
                connectionPersistence.lastServerResponse = Date.now();
            } else {
                // Disconnesso: tenta riconnessione
                attemptReconnection();
            }
        }

        async function subscribeToPushNotifications() {
            try {
                const registration = await navigator.serviceWorker.ready;

                // Genera chiavi VAPID (in produzione dovrebbero essere sul server)
                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: 'BEl62iUYgUivxIkv69yViEuiBIa-Ib9-SkvMeAtA3LFgDzkrxZJjSgSnfckjBJuBkr3qBUYIHBQFLXYp5Nksh8U' // VAPID public key
                });

                // Invia subscription al server
                await fetch('/api/subscribe-notifications', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        subscription: subscription,
                        partecipanteId: playerData.id
                    })
                });

                console.log('‚úÖ Push notifications configurate');
            } catch (error) {
                console.log('‚ö†Ô∏è Push notifications non disponibili:', error);
            }
        }

        function setupNetworkListeners() {
            // Network change events
            window.addEventListener('online', () => {
                console.log('üåê Rete disponibile - riconnessione...');
                connectionPersistence.reconnectAttempts = 0;
                if (!socket || !socket.connected) {
                    attemptReconnection();
                }
                updateConnectionStatus(true);
            });

            window.addEventListener('offline', () => {
                console.log('üì° Rete non disponibile');
                updateConnectionStatus(false);
            });

            // Page visibility optimizations
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') {
                    console.log('üëÅÔ∏è App in foreground - ottimizzando connessione...');

                    // Riduci frequenza heartbeat quando in foreground
                    if (connectionPersistence.heartbeatInterval) {
                        clearInterval(connectionPersistence.heartbeatInterval);
                        connectionPersistence.heartbeatInterval = setInterval(maintainConnectionPWA, 3000);
                    }

                    // Verifica connessione immediata
                    if (!socket || !socket.connected) {
                        attemptReconnection();
                    }
                } else {
                    console.log('üì± App in background - modalit√† risparmio...');

                    // Aumenta frequenza heartbeat quando in background
                    if (connectionPersistence.heartbeatInterval) {
                        clearInterval(connectionPersistence.heartbeatInterval);
                        connectionPersistence.heartbeatInterval = setInterval(maintainConnectionPWA, 1500);
                    }
                }
            });
        }

        function updateConnectionStatus(isOnline) {
            const statusEl = document.getElementById('connectionStatus');
            if (statusEl) {
                if (isOnline) {
                    statusEl.className = 'connection-status status-connected';
                    statusEl.textContent = '‚úÖ Connesso al FantaGTS';
                } else {
                    statusEl.className = 'connection-status status-waiting';
                    statusEl.textContent = 'üì° Riconnessione in corso...';
                }
            }
        }

        // Mantieni connessione attiva
        function maintainConnection() {
            if (!socket) {
                attemptReconnection();
                return;
            }

            if (socket.connected) {
                // Connesso: invia heartbeat
                socket.emit('heartbeat', {
                    timestamp: Date.now(),
                    type: 'persistence_check'
                });
                connectionPersistence.reconnectAttempts = 0;
                connectionPersistence.lastServerResponse = Date.now();
            } else {
                // Disconnesso: tenta riconnessione
                attemptReconnection();
            }
        }

        // Tentativo di riconnessione intelligente
        function attemptReconnection() {
            if (connectionPersistence.isReconnecting) return;
            if (connectionPersistence.reconnectAttempts >= connectionPersistence.maxReconnectAttempts) return;

            connectionPersistence.isReconnecting = true;
            connectionPersistence.reconnectAttempts++;

            console.log(`üîÑ Tentativo riconnessione #${connectionPersistence.reconnectAttempts}`);

            // Strategia di backoff esponenziale
            const delay = Math.min(1000 * Math.pow(1.5, connectionPersistence.reconnectAttempts), 10000);

            setTimeout(() => {
                try {
                    initializeSocket();
                    connectionPersistence.isReconnecting = false;
                } catch (err) {
                    console.error('Errore riconnessione:', err);
                    connectionPersistence.isReconnecting = false;
                }
            }, delay);
        }

        // Service Worker per background processing
        function registerServiceWorkerForBackground() {
            if ('serviceWorker' in navigator) {
                // Crea un service worker inline
                const swCode = `
                    self.addEventListener('message', function(event) {
                        if (event.data && event.data.type === 'KEEP_ALIVE') {
                            // Mantieni il service worker attivo
                            console.log('Service Worker: Keep alive ricevuto');
                        }
                    });

                    self.addEventListener('sync', function(event) {
                        if (event.tag === 'background-sync') {
                            console.log('Service Worker: Background sync');
                        }
                    });
                `;

                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);

                navigator.serviceWorker.register(swUrl).then(registration => {
                    console.log('‚úÖ Service Worker registrato per background');

                    // Invia messaggi periodici al service worker
                    setInterval(() => {
                        if (registration.active) {
                            registration.active.postMessage({
                                type: 'KEEP_ALIVE',
                                timestamp: Date.now()
                            });
                        }
                    }, 10000);

                }).catch(err => {
                    console.log('Service Worker non disponibile:', err);
                });
            }
        }

        // Setup listeners per stati del dispositivo
        function setupDeviceStateListeners() {
            // Quando la pagina diventa invisibile
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'hidden') {
                    console.log('üì± App in background - mantenendo connessione...');
                    // Aumenta frequenza heartbeat quando in background
                    if (connectionPersistence.heartbeatInterval) {
                        clearInterval(connectionPersistence.heartbeatInterval);
                        connectionPersistence.heartbeatInterval = setInterval(maintainConnection, 1500);
                    }
                } else if (document.visibilityState === 'visible') {
                    console.log('üì± App tornata in foreground');
                    // Riduci frequenza heartbeat quando in foreground
                    if (connectionPersistence.heartbeatInterval) {
                        clearInterval(connectionPersistence.heartbeatInterval);
                        connectionPersistence.heartbeatInterval = setInterval(maintainConnection, 3000);
                    }
                    // Riconnetti se necessario
                    if (!socket || !socket.connected) {
                        attemptReconnection();
                    }
                }
            });

            // Quando la finestra perde/guadagna focus
            window.addEventListener('focus', () => {
                console.log('üîç Finestra in focus - verificando connessione...');
                if (!socket || !socket.connected) {
                    attemptReconnection();
                }
            });

            // Prima di chiudere/ricaricare la pagina
            window.addEventListener('beforeunload', () => {
                stopConnectionPersistence();
            });
        }

        // Ferma il sistema di persistenza
        function stopConnectionPersistence() {
            console.log('üõë Fermando sistema di persistenza...');

            if (connectionPersistence.wakeLock) {
                connectionPersistence.wakeLock.release();
                connectionPersistence.wakeLock = null;
            }

            if (connectionPersistence.heartbeatInterval) {
                clearInterval(connectionPersistence.heartbeatInterval);
                connectionPersistence.heartbeatInterval = null;
            }

            connectionPersistence.reconnectAttempts = 0;
            connectionPersistence.isReconnecting = false;
        }

        // Controlla sessione esistente
        async function checkExistingSession() {
            try {
                const savedData = localStorage.getItem(STORAGE_KEYS.PLAYER_DATA);
                const registrationTime = localStorage.getItem(STORAGE_KEYS.REGISTRATION_TIME);

                if (!savedData || !registrationTime) {
                    console.log('Nessuna sessione salvata trovata');
                    return;
                }

                // Controlla se la sessione non √® troppo vecchia (24 ore)
                const now = new Date().getTime();
                const savedTime = parseInt(registrationTime);
                const maxAge = 24 * 60 * 60 * 1000; // 24 ore in millisecondi

                if (now - savedTime > maxAge) {
                    console.log('Sessione scaduta, rimuovo dati salvati');
                    clearSavedSession();
                    return;
                }

                const parsedData = JSON.parse(savedData);

                // Verifica che il partecipante esista ancora nel database
                const response = await fetch('/api/partecipanti');
                if (!response.ok) {
                    console.log('Errore verifica partecipanti esistenti');
                    return;
                }

                const partecipanti = await response.json();
                const partecipanteEsistente = partecipanti.find(p => p.id === parsedData.id);

                if (partecipanteEsistente) {
                    // Ripristina i dati del giocatore
                    playerData = {
                        registered: true,
                        name: parsedData.name,
                        id: parsedData.id,
                        credits: partecipanteEsistente.crediti // Usa crediti aggiornati dal database
                    };

                    console.log('‚úÖ Sessione ripristinata per:', playerData.name);

                    // Mostra direttamente l'area di gioco
                    document.getElementById('currentPlayer').textContent = playerData.name;
                    document.getElementById('playerCredits').textContent = playerData.credits;
                    showGameArea();

                    // Registra socket quando √® pronto
                    registerSocketWhenReady();

                    // Carica la squadra del giocatore
                    await loadPlayerTeam();

                    // Mostra notifica di benvenuto
                    setTimeout(() => {
                        alert(`üëã Bentornato, ${playerData.name}!\n\nLa tua sessione √® stata ripristinata.`);
                    }, 500);

                } else {
                    console.log('Partecipante non pi√π esistente nel database');
                    clearSavedSession();
                }

            } catch (error) {
                console.error('Errore durante il ripristino della sessione:', error);
                clearSavedSession();
            }
        }

        // Registra socket quando √® pronto
        function registerSocketWhenReady() {
            const tryRegister = () => {
                if (socket && socket.connected) {
                    console.log('üîå Registrando socket come partecipante:', playerData.name);
                    socket.emit('register', {
                        nome: playerData.name,
                        tipo: 'partecipante',
                        partecipanteId: playerData.id
                    });
                } else {
                    console.log('üîå Socket non ancora pronto, riprovo...');
                    setTimeout(tryRegister, 500);
                }
            };

            // Se il socket √® gi√† connesso, registra subito
            if (socket && socket.connected) {
                tryRegister();
            } else {
                // Altrimenti aspetta che si connetta
                if (socket) {
                    socket.on('connect', tryRegister);
                } else {
                    // Socket non ancora inizializzato, riprova
                    setTimeout(tryRegister, 1000);
                }
            }
        }

        // Salva sessione
        function saveSession() {
            try {
                const dataToSave = {
                    name: playerData.name,
                    id: playerData.id,
                    credits: playerData.credits
                };

                localStorage.setItem(STORAGE_KEYS.PLAYER_DATA, JSON.stringify(dataToSave));
                localStorage.setItem(STORAGE_KEYS.REGISTRATION_TIME, new Date().getTime().toString());

                console.log('‚úÖ Sessione salvata per:', playerData.name);
            } catch (error) {
                console.error('Errore salvataggio sessione:', error);
            }
        }

        // Pulisci sessione salvata
        function clearSavedSession() {
            try {
                localStorage.removeItem(STORAGE_KEYS.PLAYER_DATA);
                localStorage.removeItem(STORAGE_KEYS.REGISTRATION_TIME);
                console.log('üóëÔ∏è Sessione salvata rimossa');
            } catch (error) {
                console.error('Errore rimozione sessione:', error);
            }
        }

        // Carica squadra del giocatore
        async function loadPlayerTeam() {
            try {
                const response = await fetch(`/api/squadra-partecipante/${playerData.id}`);
                if (!response.ok) {
                    console.log('Squadra non ancora formata o endpoint non disponibile');
                    resetTeamUI();
                    return;
                }

                const squadra = await response.json();
                console.log('Squadra caricata:', squadra);

                // Aggiorna la UI con i giocatori della squadra
                squadra.forEach(giocatore => {
                    const [posizione] = giocatore.slot_id.split('_');
                    const slotElement = document.querySelector(`[data-position="${posizione}"]`);

                    if (slotElement) {
                        slotElement.classList.remove('empty');
                        slotElement.classList.add('filled');

                        // Calcola colori
                        const teamColor = getTeamColor(giocatore.colore);
                        const textColor = getTextColorForTeam(giocatore.colore);

                        slotElement.innerHTML = `
                            <strong style="color: ${textColor} !important;">${posizione}</strong><br>
                            <span style="color: ${textColor} !important;">${giocatore.giocatore_attuale}</span><br>
                            <small style="opacity: 0.8; color: ${textColor} !important;">Squadra: ${giocatore.colore}</small>
                        `;

                        slotElement.style.borderColor = teamColor;
                        slotElement.style.borderWidth = '4px';
                        slotElement.style.borderStyle = 'solid';

                        if (teamColor.startsWith('#')) {
                            slotElement.style.backgroundColor = teamColor + '80';
                        } else {
                            slotElement.style.backgroundColor = teamColor.replace('hsl', 'hsla').replace(')', ', 0.5)');
                        }
                    }
                });

                // Aggiorna contatori
                const slotsRiempiti = document.querySelectorAll('.team-slot.filled').length;
                document.getElementById('teamCount').textContent = slotsRiempiti;

            } catch (error) {
                console.error('Errore caricamento squadra:', error);
            }
        }

        // Reset UI squadra
        function resetTeamUI() {
            document.querySelectorAll('.team-slot').forEach(slot => {
                slot.classList.remove('filled');
                slot.classList.add('empty');
                slot.style.borderColor = '#4a5568';
                slot.style.backgroundColor = 'rgba(74, 85, 104, 0.3)';

                const position = slot.dataset.position;
                slot.innerHTML = `<strong>${position}</strong><br>-`;
            });

            // Aggiorna contatori
            document.getElementById('teamCount').textContent = '0';
            document.getElementById('teamPoints').textContent = '0';
        }

        // Connessione WebSocket
        function initializeSocket() {
            if (typeof io === 'undefined') {
                console.log('Socket.io non caricato');
                return;
            }

            socket = io();

            socket.on('connect', () => {
                console.log('Connesso al server via WebSocket');
            });

            socket.on('disconnect', () => {
                console.log('Disconnesso dal server');
            });

            socket.on('registered', (data) => {
                if (data.success) {
                    console.log('‚úÖ Registrazione WebSocket confermata per partecipante');
                } else {
                    console.error('‚ùå Registrazione WebSocket fallita:', data);
                }
            });

            socket.on('round_started', (data) => {
                showBiddingPhase(data);
            });

            socket.on('offerte_update', (data) => {
                updateOffersStatus(data);
            });

            socket.on('crediti_aggiornati', (data) => {
                playerData.credits = data.crediti;
                updateCreditsDisplay();
                saveSession();
                console.log('Crediti aggiornati:', data.crediti);
            });

            socket.on('round_ended', (data) => {
                console.log('Round terminato ricevuto:', data);
                showResultsPhase(data);
                updateMyTeamFromResults(data.round, data.risultati);
                resetBiddingInterface();
                saveSession();
                showWaitingPhase();
            });

            socket.on('bid_confirmed', (data) => {
                console.log('‚úÖ Puntata confermata dal server:', data);

                // Feedback visivo - PUNTATA CONFERMATA
                const button = document.getElementById('confirmBidBtn');
                button.disabled = true;
                button.textContent = '‚úÖ Puntata Confermata';
                button.style.background = '#10b981';

                // Disabilita tutta l'interfaccia di puntata
                document.querySelectorAll('.player-card').forEach(card => {
                    card.style.pointerEvents = 'none';
                    card.style.opacity = '0.7';
                });
                document.getElementById('bidAmount').disabled = true;

                // Mostra messaggio di attesa
                setTimeout(() => {
                    alert('‚úÖ Puntata confermata!\n\nOra attendi che tutti completino le loro offerte.');
                }, 500);
            });

            socket.on('bid_error', (data) => {
                console.error('‚ùå Errore puntata:', data);
                alert('‚ùå Errore: ' + data.message);
                resetBiddingInterface();
            });

            socket.on('aste_resettate', (data) => {
                console.log('üîÑ Aste resettate dal server:', data);

                // Aggiorna crediti
                playerData.credits = data.creditiRipristinati;
                updateCreditsDisplay();

                // Reset completo della squadra
                resetTeamUI();

                // Pulisci sessione salvata e risalva
                clearSavedSession();
                saveSession();

                // Mostra notifica
                alert('üîÑ Le aste sono state resettate dal Master!\n\nLa tua squadra √® stata azzerata e i crediti ripristinati.');
            });

            socket.on('heartbeat_response', (data) => {
                connectionPersistence.lastServerResponse = Date.now();
            });
        }

        // Registrazione giocatore
        async function registerPlayer() {
            const name = document.getElementById('playerName').value.trim();
            const email = document.getElementById('playerEmail').value.trim();
            const phone = document.getElementById('playerPhone').value.trim();

            if (!name) {
                alert('Inserisci il tuo nome!');
                return;
            }

            try {
                // Registra nel database
                const response = await fetch('/api/partecipanti', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        nome: name,
                        email: email,
                        telefono: phone,
                        crediti: 2000
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    playerData.registered = true;
                    playerData.name = name;
                    playerData.id = result.id;
                    playerData.credits = 2000;

                    // Salva la sessione
                    saveSession();

                    // Registra socket quando √® pronto
                    registerSocketWhenReady();

                    // Mostra area gioco
                    document.getElementById('currentPlayer').textContent = name;
                    document.getElementById('playerCredits').textContent = 2000;

                    updateCreditsDisplay();
                    showGameArea();

                    alert('‚úÖ Registrato con successo!\n\nOra sei nel FantaGTS e in attesa che il Master avvii le aste.\n\nüí° La tua sessione verr√† salvata automaticamente.');

                } else {
                    const error = await response.json();
                    alert('‚ùå Errore registrazione: ' + error.error);
                }
            } catch (error) {
                alert('‚ùå Errore di connessione al server');
                console.error('Errore registrazione:', error);
            }
        }

        function showGameArea() {
            document.getElementById('registration-area').style.display = 'none';
            document.getElementById('game-area').style.display = 'block';
            showWaitingPhase();

            // AVVIA SISTEMA DI PERSISTENZA CONNESSIONE
            startConnectionPersistence();
        }

        function showWaitingPhase() {
            document.getElementById('waiting-phase').style.display = 'block';
            document.getElementById('bidding-phase').style.display = 'none';
        }

        function showBiddingPhase(data) {
            document.getElementById('waiting-phase').style.display = 'none';
            document.getElementById('bidding-phase').style.display = 'block';

            if (data && data.round) {
                document.getElementById('currentRound').textContent = data.round;
                loadAvailablePlayers(data.slots || []);
            }
        }

        function updateCreditsDisplay() {
            document.getElementById('creditsDisplay').textContent = playerData.credits;
            document.getElementById('playerCredits').textContent = playerData.credits;
        }

        function resetBiddingInterface() {
            // Riabilita input crediti
            document.getElementById('bidAmount').disabled = false;
            document.getElementById('bidAmount').value = '';

            // Riabilita tutti i controlli
            document.querySelectorAll('.player-card').forEach(card => {
                card.style.pointerEvents = 'auto';
                card.style.opacity = '1';
                card.classList.remove('selected');
            });

            // Reset pulsante conferma
            const confirmBtn = document.getElementById('confirmBidBtn');
            confirmBtn.disabled = true;
            confirmBtn.textContent = 'Conferma Puntata';
            confirmBtn.style.background = '#ef4444';

            // Nascondi sezione bid
            document.getElementById('bidSection').style.display = 'none';

            console.log('üîÑ Interfaccia di puntata resettata');
        }

        function loadAvailablePlayers(slots) {
            const grid = document.getElementById('playersGrid');
            grid.innerHTML = '';

            // Se non abbiamo slots dal server, usa dati mock per test
            const players = slots.length > 0 ? slots : [
                { id: 'M1_ROSSO', giocatore_attuale: 'SPANO', colore: 'rosso' },
                { id: 'M1_BLU', giocatore_attuale: 'BIANCHI', colore: 'blu' },
                { id: 'M1_VERDE', giocatore_attuale: 'VERDI', colore: 'verde' }
            ];

            players.forEach(player => {
                const card = document.createElement('div');
                card.className = 'player-card';
                card.dataset.playerId = player.id;

                card.innerHTML = `
                            <div class="team-color-dot" style="background-color: ${player.colore}"></div>
                            <div class="player-name">${player.giocatore_attuale}</div>
                            <div style="font-size: 0.8em; opacity: 0.8;">Squadra ${player.colore}</div>
                        `;

                card.addEventListener('click', () => selectPlayer(player));
                grid.appendChild(card);
            });
        }

        function selectPlayer(player) {
            // Rimuovi selezione precedente
            document.querySelectorAll('.player-card').forEach(card => {
                card.classList.remove('selected');
            });

            // Seleziona nuovo giocatore
            document.querySelector(`[data-player-id="${player.id}"]`).classList.add('selected');

            // Mostra sezione puntata
            document.getElementById('bidSection').style.display = 'block';
            document.getElementById('selectedPlayerInfo').innerHTML = `
                        <strong>Selezionato: ${player.giocatore_attuale || player.name}</strong><br>
                        <small>Squadra ${player.colore}</small>
                    `;

            updateCreditsDisplay();
            updateBidButton();
        }

        function updateBidButton() {
            const button = document.getElementById('confirmBidBtn');
            const amount = parseInt(document.getElementById('bidAmount').value) || 0;
            const hasValidBid = amount > 0 && amount <= playerData.credits;
            const hasSelection = document.querySelector('.player-card.selected') !== null;

            button.disabled = !(hasSelection && hasValidBid);

            if (hasSelection && hasValidBid) {
                const playerName = document.querySelector('.player-card.selected .player-name').textContent;
                button.textContent = `Punta ${amount} su ${playerName}`;
            } else {
                button.textContent = 'Conferma Puntata';
            }
        }

        function confirmBid() {
            const amount = parseInt(document.getElementById('bidAmount').value);
            const selectedCard = document.querySelector('.player-card.selected');

            if (!selectedCard || !amount || amount <= 0) {
                alert('Seleziona un giocatore e inserisci un importo valido!');
                return;
            }

            const playerId = selectedCard.dataset.playerId;
            const playerName = selectedCard.querySelector('.player-name').textContent;

            // CONFERMA A 2 STEP
            const confirmMessage = `Stai per puntare\n\n${amount} crediti\n\nsu ${playerName}`;

            if (!confirm(confirmMessage)) {
                return; // Utente ha annullato
            }

            // Invia offerta al server se socket disponibile
            if (socket && socket.connected) {
                socket.emit('place_bid', {
                    round: document.getElementById('currentRound').textContent,
                    slot: playerId,
                    importo: amount
                });
            }

            // Feedback visivo immediato
            const button = document.getElementById('confirmBidBtn');
            button.disabled = true;
            button.textContent = '‚è≥ Invio in corso...';
            button.style.background = '#ed8936';
        }

        function updateOffersStatus(data) {
            const statusEl = document.getElementById('offersStatus');
            const messageEl = document.getElementById('offersMessage');

            if (data.mancano > 0) {
                statusEl.textContent = `${data.offerteRicevute}/${data.partecipantiConnessi}`;
                statusEl.style.color = '#f59e0b';
                messageEl.textContent = `Mancano ${data.mancano} offerte per proseguire`;
            } else {
                statusEl.textContent = '‚úÖ Tutti hanno offerto!';
                statusEl.style.color = '#10b981';
                messageEl.textContent = 'Elaborazione risultati in corso...';
            }
        }

        function showResultsPhase(data) {
            alert('Round terminato!');
            showWaitingPhase();
        }

        function updateMyTeamFromResults(round, risultati) {
            // Trova i miei acquisti in questo round
            const mieiAcquisti = risultati.filter(r => r.nome === playerData.name);

            console.log('üéØ I miei acquisti:', mieiAcquisti);

            mieiAcquisti.forEach(acquisto => {
                // Estrai informazioni dal slot (es: "M1_ROSSO")
                const [posizione, coloreSquadra] = acquisto.slot.split('_');

                // Trova lo slot corrispondente nella UI
                const slotElement = document.querySelector(`[data-position="${posizione}"]`);
                if (slotElement) {
                    slotElement.classList.remove('empty');
                    slotElement.classList.add('filled');

                    // Trova il nome del giocatore dal database
                    fetch(`/api/slot-info/${acquisto.slot}`)
                        .then(response => response.json())
                        .then(slotInfo => {
                            const teamColor = getTeamColor(slotInfo.colore);
                            const textColor = getTextColorForTeam(slotInfo.colore);

                            slotElement.innerHTML = `
                                <strong style="color: ${textColor} !important;">${posizione}</strong><br>
                                <span style="color: ${textColor} !important;">${slotInfo.giocatore_attuale}</span><br>
                                <small style="opacity: 0.8; color: ${textColor} !important;">Squadra: ${slotInfo.colore}</small>
                            `;

                            slotElement.style.borderColor = teamColor;
                            slotElement.style.borderWidth = '4px';
                            slotElement.style.borderStyle = 'solid';

                            if (teamColor.startsWith('#')) {
                                slotElement.style.backgroundColor = teamColor + '80';
                            } else {
                                slotElement.style.backgroundColor = teamColor.replace('hsl', 'hsla').replace(')', ', 0.5)');
                            }
                        })
                        .catch((error) => {
                            console.error('‚ùå Errore fetch slot-info:', error);
                            // Fallback se API non disponibile
                            slotElement.innerHTML = `<strong>${posizione}</strong><br>Giocatore`;
                            const teamColor = getTeamColor(coloreSquadra);

                            slotElement.style.borderColor = teamColor;
                            slotElement.style.borderWidth = '4px';
                            slotElement.style.borderStyle = 'solid';

                            if (teamColor.startsWith('#')) {
                                slotElement.style.backgroundColor = teamColor + '80';
                            } else {
                                slotElement.style.backgroundColor = teamColor.replace('hsl', 'hsla').replace(')', ', 0.5)');
                            }
                        });
                }
            });

            // Aggiorna contatori
            const slotsRiempiti = document.querySelectorAll('.team-slot.filled').length;
            document.getElementById('teamCount').textContent = slotsRiempiti;
        }

        function getTeamColor(nomeColore) {
            const colori = {
                'rosso': '#ef4444', 'rossa': '#ef4444',
                'blu': '#3b82f6', 'azzurro': '#06b6d4', 'azzurra': '#06b6d4',
                'verde': '#10b981', 'giallo': '#f59e0b', 'gialla': '#f59e0b',
                'viola': '#8b5cf6', 'arancione': '#f97316', 'rosa': '#ec4899',
                'marrone': '#92400e', 'nero': '#374151', 'nera': '#374151',
                'bianco': '#f3f4f6', 'bianca': '#f3f4f6',
                'grigio': '#6b7280', 'grigia': '#6b7280',
                'lime': '#84cc16', 'indaco': '#6366f1', 'fucsia': '#d946ef',
                'smeraldo': '#10b981', 'royal': '#1e40af', 'ciano': '#06b6d4',
                'bordeaux': '#7c2d12', 'crema': '#fef3c7', 'lilla': '#c4b5fd',
                'celeste': '#06b6d4', 'cielo': '#06b6d4',
                'oro': '#eab308', 'dorato': '#eab308', 'dorata': '#eab308',
                'argento': '#9ca3af', 'beige': '#d6d3d1', 'lavanda': '#c4b5fd'
            };

            const coloreLowerCase = nomeColore.toLowerCase().trim();

            if (colori[coloreLowerCase]) {
                return colori[coloreLowerCase];
            }

            // Fallback: genera colore hash
            return generaColoreHash(nomeColore);
        }

        function getTextColorForTeam(nomeColore) {
            const coloriChiari = [
                'bianco', 'bianca', 'crema', 'giallo', 'gialla',
                'lime', 'oro', 'dorato', 'dorata', 'argento', 'beige'
            ];

            const coloreLowerCase = nomeColore.toLowerCase().trim();

            const isColoreChiaro = coloriChiari.some(colore =>
                coloreLowerCase.includes(colore) || colore.includes(coloreLowerCase)
            );

            return isColoreChiaro ? '#1a202c' : '#ffffff';
        }

        function generaColoreHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }

            const hue = Math.abs(hash) % 360;
            const saturation = 65 + (Math.abs(hash) % 35);
            const lightness = 45 + (Math.abs(hash) % 20);

            return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
        }

        function logout() {
            if (confirm('Sei sicuro di voler uscire?\n\nDovrai reinserire i tuoi dati per rientrare.')) {
                stopConnectionPersistence();

                clearSavedSession();
                playerData = {
                    registered: false,
                    name: '',
                    id: '',
                    credits: 2000
                };

                if (socket && socket.connected) {
                    socket.disconnect();
                }

                location.reload();
            }
        }

        // Event listeners
        document.getElementById('bidAmount').addEventListener('input', updateBidButton);
        document.getElementById('playerName').focus();

        console.log('‚úÖ FantaGTS Client inizializzato correttamente');
    </script>

    <!-- PWA Registration -->
    <script>
        // Registrazione Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('‚úÖ Service Worker registrato:', registration.scope);

                        // Controlla aggiornamenti
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // Nuovo SW disponibile
                                    if (confirm('üîÑ Nuova versione disponibile! Vuoi aggiornarla?')) {
                                        newWorker.postMessage({ type: 'SKIP_WAITING' });
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.log('‚ùå Errore registrazione Service Worker:', error);
                    });
            });

            // Ricarica quando nuovo SW prende controllo
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                window.location.reload();
            });
        }

        // PWA Install Prompt
        let deferredPrompt;

        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('üíæ PWA installabile rilevata');
            e.preventDefault();
            deferredPrompt = e;

            // Mostra banner di installazione personalizzato dopo 5 secondi
            setTimeout(showInstallBanner, 5000);
        });

        function showInstallBanner() {
            // Controlla se √® gi√† stata "installata" (icona creata)
            if (localStorage.getItem('pwa_homescreen_added') ||
                localStorage.getItem('install_instructions_shown')) {
                return; // Non mostrare pi√π il banner
            }

            const installBanner = document.createElement('div');
            installBanner.style.cssText = `
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(66, 153, 225, 0.95);
            color: white;
            padding: 15px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
            animation: slideUp 0.3s ease;
        `;

            installBanner.innerHTML = `
            <div>
                <strong>üì± Aggiungi FantaGTS alla Home</strong><br>
                <small>Per accesso rapido e connessione stabile</small>
            </div>
            <div>
                <button onclick="showInstructions()" style="background: white; color: #4299e1; border: none; padding: 8px 15px; border-radius: 5px; margin-right: 10px; font-weight: bold;">Come fare</button>
                <button onclick="dismissInstallPermanently()" style="background: transparent; color: white; border: 1px solid white; padding: 8px 10px; border-radius: 5px;">‚úï</button>
            </div>
        `;

            document.body.appendChild(installBanner);
        }

        function showInstructions() {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const instructions = isIOS ?
                "üì§ 1. Tocca 'Condividi' in basso\nüì± 2. Scegli 'Aggiungi alla schermata Home'\n‚úÖ 3. Tocca 'Aggiungi'" :
                "‚ãÆ 1. Tocca 'Menu' (3 puntini) in alto\nüì± 2. Scegli 'Aggiungi alla schermata Home'\n‚úÖ 3. Tocca 'Aggiungi'";

            alert("üè† Come aggiungere FantaGTS alla Home:\n\n" + instructions +
                "\n\nüí° Una volta aggiunta, aprila sempre dall'icona per la migliore esperienza!");

            dismissInstallPermanently();
        }

        function dismissInstallPermanently() {
            const banner = document.querySelector('[style*="slideUp"]');
            if (banner) banner.remove();

            // Segna come "installata" per non mostrare pi√π il banner
            localStorage.setItem('install_instructions_shown', 'true');
            localStorage.setItem('pwa_homescreen_added', 'true');
        }

        // E modifica la rilevazione appinstalled:
        window.addEventListener('appinstalled', (evt) => {
            console.log('‚úÖ FantaGTS aggiunta alla Home Screen!');
            localStorage.setItem('pwa_homescreen_added', 'true');

            setTimeout(() => {
                alert('üéâ FantaGTS aggiunta alla Home!\n\nüí° Usa sempre l\'icona dalla Home per aprirla.');
            }, 1000);
        });

        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('‚úÖ PWA installata dall\'utente');
                    }
                    deferredPrompt = null;
                    dismissInstall();
                });
            }
        }

        function dismissInstall() {
            const banner = document.querySelector('[style*="slideUp"]');
            if (banner) banner.remove();
            localStorage.setItem('pwa_install_dismissed', 'true');
        }

        // Rileva quando l'app viene installata
        window.addEventListener('appinstalled', (evt) => {
            console.log('‚úÖ FantaGTS PWA installata con successo!');
            localStorage.setItem('pwa_installed', 'true');
            // Mostra messaggio di benvenuto
            setTimeout(() => {
                alert('üéâ FantaGTS installata!\n\nOra puoi trovarla nella tua home screen.');
            }, 1000);
        });

        // DEBUG PWA - AGGIUNGI QUI
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('‚úÖ PWA installabile rilevata dal debug!');
            alert('üéâ DEBUG: PWA installabile rilevata! Menu dovrebbe avere "Installa app".');
        });

        // Test modalit√† standalone vs browser
        setTimeout(() => {
            if (window.matchMedia('(display-mode: standalone)').matches) {
                console.log('üè† DEBUG: App in modalit√† standalone - SUCCESSO!');
                document.body.style.border = '5px solid green';
                alert('‚úÖ SUCCESSO! App installata correttamente (bordo verde)');
            } else {
                console.log('üåê DEBUG: App in modalit√† browser - ancora da installare');
                document.body.style.border = '5px solid red';
                console.log('üîç Cerca nel menu Chrome "Installa app" o icona ‚äï nella barra indirizzi');
            }
        }, 2000);

    </script>

</body>
</html>