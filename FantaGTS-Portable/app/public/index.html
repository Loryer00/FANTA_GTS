<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FantaGTS - Partecipante</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            min-height: 100vh;
            color: #e2e8f0;
            padding: 10px;
        }

        .container {
            max-width: 450px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            padding: 20px 0;
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .registration-form {
            background: rgba(255,255,255,0.08);
            padding: 25px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #cbd5e0;
        }

        .input-group input {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            background: rgba(255,255,255,0.95);
            color: #2d3748;
            font-size: 1.1em;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 0;
        }

        .btn-primary {
            background: #4299e1;
            color: white;
            border: 1px solid #4299e1;
        }

        .btn-primary:hover {
            background: #3182ce;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(66, 153, 225, 0.4);
        }

        .section {
            background: rgba(255,255,255,0.08);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255,255,255,0.08);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .connection-status {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .status-connected {
            background: rgba(72, 187, 120, 0.2);
            border: 2px solid #48bb78;
            color: #68d391;
        }

        .status-waiting {
            background: rgba(237, 137, 54, 0.2);
            border: 2px solid #ed8936;
            color: #f6ad55;
        }

        .round-info {
            background: rgba(245, 101, 101, 0.2);
            border: 3px solid #f56565;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 20px;
        }

        .big-timer {
            font-size: 3em;
            font-weight: bold;
            color: #4299e1;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            margin: 15px 0;
        }

        .players-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .player-card {
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
            color: #e2e8f0;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }

        .player-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
            border-color: #4299e1;
        }

        .player-card.selected {
            border-color: #4299e1;
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: white;
        }

        .player-name {
            font-weight: bold;
            margin-bottom: 8px;
        }

        .team-color-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin: 0 auto 8px;
            border: 2px solid white;
        }

        .bid-section {
            background: rgba(255,255,255,0.08);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .selected-player-info {
            background: rgba(72, 187, 120, 0.2);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 15px;
            border: 2px solid #48bb78;
            color: #68d391;
        }

        .bid-input {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            background: rgba(255,255,255,0.95);
            color: #2d3748;
            font-size: 1.3em;
            text-align: center;
            font-weight: bold;
            margin-bottom: 15px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .confirm-bid {
            width: 100%;
            padding: 15px;
            background: #f56565;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            border: 1px solid #f56565;
        }

        .confirm-bid:disabled {
            background: #4a5568;
            cursor: not-allowed;
            border-color: #4a5568;
        }

        .my-team {
            background: rgba(255,255,255,0.08);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .team-slots {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            margin-top: 15px;
        }

        .team-slot {
            background: rgba(255,255,255,0.08);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid transparent;
            min-height: 60px;
        }

        .team-slot.filled {
            background: rgba(72, 187, 120, 0.2);
            border: 4px solid #48bb78;
            color: #68d391;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            min-height: 70px;
        }

        .team-slot.filled small {
            font-weight: normal;
            opacity: 0.8;
        }

        .team-slot.empty {
            background: rgba(74, 85, 104, 0.3);
            border-color: #4a5568;
            opacity: 0.7;
            color: #a0aec0;
        }

        @media (max-width: 480px) {
            .players-grid {
                grid-template-columns: 1fr;
            }
            .big-timer {
                font-size: 2.5em;
            }
        }
</style>

</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéæ FantaGTS</h1>
            <p>Fantasy Tennis del Circolo</p>
        </div>

        <!-- Registrazione -->
        <div id="registration-area">
            <div class="registration-form">
                <h2>üëã Benvenuto!</h2>
                <p style="margin-bottom: 20px;">Inserisci i tuoi dati per partecipare al FantaGTS</p>
                
                <div class="input-group">
                    <label>Il tuo nome:</label>
                    <input type="text" id="playerName" placeholder="Lorenzo Buselli" autocomplete="name">
                </div>
                
                <div class="input-group">
                    <label>Email (opzionale):</label>
                    <input type="email" id="playerEmail" placeholder="lorenzo@email.com" autocomplete="email">
                </div>
                
                <div class="input-group">
                    <label>Telefono (opzionale):</label>
                    <input type="tel" id="playerPhone" placeholder="333-1234567" autocomplete="tel">
                </div>
                
                <button class="btn btn-primary" onclick="registerPlayer()">
                    üöÄ Entra nel FantaGTS
                </button>
            </div>
        </div>

        <!-- Area di gioco -->
        <div id="game-area" style="display: none;">
            <!-- Stato connessione -->
            <div id="connectionStatus" class="connection-status status-connected">
                ‚úÖ Connesso al FantaGTS
            </div>

            <!-- Info utente -->
            <div class="user-info">
                <div>
                    <strong id="currentPlayer">--</strong>
                </div>
                <div>
                    üí∞ <span id="playerCredits">2000</span> crediti
                </div>
            </div>
			
			<!-- NUOVO: Pulsante logout -->
<div style="text-align: center; margin-bottom: 15px;">
    <button onclick="logout()" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: #e2e8f0; padding: 8px 15px; border-radius: 6px; font-size: 0.9em; cursor: pointer;">
        üö™ Cambia Utente
    </button>
</div>

            <!-- Attesa round -->
            <div id="waiting-phase" class="section" style="display: none;">
                <h2>‚è≥ In Attesa</h2>
                <p>Il Master avvier√† il prossimo round quando tutti sono pronti.</p>
                <p><strong>Prossimo round: <span id="nextRound">M1</span></strong></p>
            </div>

            <!-- Round attivo -->
            <div id="bidding-phase" style="display: none;">
                <div class="round-info">
                    <div style="font-size: 1.5em; font-weight: bold; margin-bottom: 10px;">
                        Round <span id="currentRound">M1</span>
                    </div>
                    <div id="offersStatus" class="big-timer">
                        Waiting...
                    </div>
                    <p id="offersMessage">In attesa che tutti facciano le loro offerte</p>
                </div>

                <!-- Griglia giocatori -->
                <div class="players-grid" id="playersGrid">
                    <!-- I giocatori verranno caricati qui -->
                </div>

                <!-- Sezione puntata -->
<div id="bidSection" class="bid-section" style="display: none;">
    <div id="selectedPlayerInfo" class="selected-player-info">
        <strong>Nessun giocatore selezionato</strong>
    </div>
    
    <!-- AGGIUNGI questa sezione crediti -->
    <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; margin-bottom: 10px; text-align: center;">
        <strong>üí∞ Crediti disponibili: <span id="creditsDisplay">2000</span></strong>
    </div>
    
    <input type="number" class="bid-input" id="bidAmount" placeholder="Inserisci quanto vuoi puntare" min="1">
                    
    <button class="confirm-bid" id="confirmBidBtn" onclick="confirmBid()" disabled>
        Conferma Puntata
    </button>
</div>
            </div>

            <!-- La mia squadra -->
            <div class="my-team">
                <h2>üèÜ La Mia Squadra</h2>
                <div id="myTeamStats">
                    <p>Giocatori: <span id="teamCount">0</span>/10 | Punti: <span id="teamPoints">0</span></p>
                </div>
                <div class="team-slots" id="teamSlots">
                    <div class="team-slot empty" data-position="M1"><strong>M1</strong><br>-</div>
                    <div class="team-slot empty" data-position="M2"><strong>M2</strong><br>-</div>
                    <div class="team-slot empty" data-position="M3"><strong>M3</strong><br>-</div>
                    <div class="team-slot empty" data-position="M4"><strong>M4</strong><br>-</div>
                    <div class="team-slot empty" data-position="M5"><strong>M5</strong><br>-</div>
                    <div class="team-slot empty" data-position="M6"><strong>M6</strong><br>-</div>
                    <div class="team-slot empty" data-position="M7"><strong>M7</strong><br>-</div>
                    <div class="team-slot empty" data-position="F1"><strong>F1</strong><br>-</div>
                    <div class="team-slot empty" data-position="F2"><strong>F2</strong><br>-</div>
                    <div class="team-slot empty" data-position="F3"><strong>F3</strong><br>-</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variabili globali
let socket;
let playerData = {
    registered: false,
    name: '',
    id: '',
    credits: 2000
};

// NUOVO: Chiavi per localStorage
const STORAGE_KEYS = {
    PLAYER_DATA: 'fantagts_player_data',
    REGISTRATION_TIME: 'fantagts_registration_time'
};

// Inizializzazione MODIFICATA
document.addEventListener('DOMContentLoaded', () => {
    console.log('FantaGTS Client caricato');
    
    // NUOVO: Controlla se esiste una sessione salvata
    checkExistingSession();
    
    // Tentiamo connessione socket ma non bloccante
    try {
        initializeSocket();
    } catch (error) {
        console.log('Socket.io non disponibile, modalit√† base attiva');
    }
});

        // NUOVA FUNZIONE: Controlla sessione esistente
        async function checkExistingSession() {
            try {
                const savedData = localStorage.getItem(STORAGE_KEYS.PLAYER_DATA);
                const registrationTime = localStorage.getItem(STORAGE_KEYS.REGISTRATION_TIME);

                if (!savedData || !registrationTime) {
                    console.log('Nessuna sessione salvata trovata');
                    return;
                }

                // Controlla se la sessione non √® troppo vecchia (24 ore)
                const now = new Date().getTime();
                const savedTime = parseInt(registrationTime);
                const maxAge = 24 * 60 * 60 * 1000; // 24 ore in millisecondi

                if (now - savedTime > maxAge) {
                    console.log('Sessione scaduta, rimuovo dati salvati');
                    clearSavedSession();
                    return;
                }

                const parsedData = JSON.parse(savedData);

                // Verifica che il partecipante esista ancora nel database
                const response = await fetch('/api/partecipanti');
                if (!response.ok) {
                    console.log('Errore verifica partecipanti esistenti');
                    return;
                }

                const partecipanti = await response.json();
                const partecipanteEsistente = partecipanti.find(p => p.id === parsedData.id);

                if (partecipanteEsistente) {
                    // Ripristina i dati del giocatore
                    playerData = {
                        registered: true,
                        name: parsedData.name,
                        id: parsedData.id,
                        credits: partecipanteEsistente.crediti // Usa crediti aggiornati dal database
                    };

                    console.log('‚úÖ Sessione ripristinata per:', playerData.name);

                    // Mostra direttamente l'area di gioco
                    document.getElementById('currentPlayer').textContent = playerData.name;
                    document.getElementById('playerCredits').textContent = playerData.credits;
                    showGameArea();

                    // Registra socket quando √® pronto
                    registerSocketWhenReady();

                    // Carica la squadra del giocatore
                    await loadPlayerTeam();

                    // Mostra notifica di benvenuto
                    setTimeout(() => {
                        alert(`üëã Bentornato, ${playerData.name}!\n\nLa tua sessione √® stata ripristinata.`);
                    }, 500);

                } else {
                    console.log('Partecipante non pi√π esistente nel database');
                    clearSavedSession();
                }

            } catch (error) {
                console.error('Errore durante il ripristino della sessione:', error);
                clearSavedSession();
            }
        }

        // NUOVA FUNZIONE: Registra socket quando √® pronto
        function registerSocketWhenReady() {
            const tryRegister = () => {
                if (socket && socket.connected) {
                    console.log('üîå Registrando socket come partecipante:', playerData.name);
                    socket.emit('register', {
                        nome: playerData.name,
                        tipo: 'partecipante',
                        partecipanteId: playerData.id
                    });
                } else {
                    console.log('üîå Socket non ancora pronto, riprovo...');
                    setTimeout(tryRegister, 500);
                }
            };

            // Se il socket √® gi√† connesso, registra subito
            if (socket && socket.connected) {
                tryRegister();
            } else {
                // Altrimenti aspetta che si connetta
                if (socket) {
                    socket.on('connect', tryRegister);
                } else {
                    // Socket non ancora inizializzato, riprova
                    setTimeout(tryRegister, 1000);
                }
            }
        }

// NUOVA FUNZIONE: Salva sessione
function saveSession() {
    try {
        const dataToSave = {
            name: playerData.name,
            id: playerData.id,
            credits: playerData.credits
        };
        
        localStorage.setItem(STORAGE_KEYS.PLAYER_DATA, JSON.stringify(dataToSave));
        localStorage.setItem(STORAGE_KEYS.REGISTRATION_TIME, new Date().getTime().toString());
        
        console.log('‚úÖ Sessione salvata per:', playerData.name);
    } catch (error) {
        console.error('Errore salvataggio sessione:', error);
    }
}

// NUOVA FUNZIONE: Pulisci sessione salvata
function clearSavedSession() {
    try {
        localStorage.removeItem(STORAGE_KEYS.PLAYER_DATA);
        localStorage.removeItem(STORAGE_KEYS.REGISTRATION_TIME);
        console.log('üóëÔ∏è Sessione salvata rimossa');
    } catch (error) {
        console.error('Errore rimozione sessione:', error);
    }
}

// NUOVA FUNZIONE: Carica squadra del giocatore
        async function loadPlayerTeam() {
            try {
                // Questo endpoint dovr√† essere creato nel server
                const response = await fetch(`/api/squadra-partecipante/${playerData.id}`);
                if (!response.ok) {
                    console.log('Squadra non ancora formata o endpoint non disponibile');
                    // NUOVO: Reset UI se non ci sono dati
                    resetTeamUI();
                    return;
                }

                const squadra = await response.json();
                console.log('Squadra caricata:', squadra);

                // Aggiorna la UI con i giocatori della squadra
                squadra.forEach(giocatore => {
                    const [posizione] = giocatore.slot_id.split('_');
                    const slotElement = document.querySelector(`[data-position="${posizione}"]`);

                    if (slotElement) {
                        slotElement.classList.remove('empty');
                        slotElement.classList.add('filled');

                        // AGGIUNGI: Calcola colori
                        const teamColor = getTeamColor(giocatore.colore);
                        const textColor = getTextColorForTeam(giocatore.colore);
                        console.log(`üé® Squadra: "${giocatore.colore}" ‚Üí Sfondo: ${teamColor}, Testo: ${textColor}`);

                        slotElement.innerHTML = `
                    <strong style="color: ${textColor} !important;">${posizione}</strong><br>
                    <span style="color: ${textColor} !important;">${giocatore.giocatore_attuale}</span><br>
                    <small style="opacity: 0.8; color: ${textColor} !important;">Squadra: ${giocatore.colore}</small>
                `;

                        slotElement.style.borderColor = teamColor;
                        slotElement.style.borderWidth = '4px';
                        slotElement.style.borderStyle = 'solid';

                        if (teamColor.startsWith('#')) {
                            slotElement.style.backgroundColor = teamColor + '80';
                        } else {
                            slotElement.style.backgroundColor = teamColor.replace('hsl', 'hsla').replace(')', ', 0.5)');
                        }
                    }
                });

                // Aggiorna contatori
                const slotsRiempiti = document.querySelectorAll('.team-slot.filled').length;
                document.getElementById('teamCount').textContent = slotsRiempiti;

            } catch (error) {
                console.error('Errore caricamento squadra:', error);
            }
        }

        // NUOVA FUNZIONE: Reset UI squadra
        function resetTeamUI() {
            document.querySelectorAll('.team-slot').forEach(slot => {
                slot.classList.remove('filled');
                slot.classList.add('empty');
                slot.style.borderColor = '#4a5568';
                slot.style.backgroundColor = 'rgba(74, 85, 104, 0.3)';

                const position = slot.dataset.position;
                slot.innerHTML = `<strong>${position}</strong><br>-`;
            });

            // Aggiorna contatori
            document.getElementById('teamCount').textContent = '0';
            document.getElementById('teamPoints').textContent = '0';
        }

        // NUOVA FUNZIONE: Registra socket quando √® pronto
        function registerSocketWhenReady() {
            const tryRegister = () => {
                if (socket && socket.connected) {
                    console.log('üîå Registrando socket come partecipante:', playerData.name);
                    socket.emit('register', {
                        nome: playerData.name,
                        tipo: 'partecipante',
                        partecipanteId: playerData.id
                    });
                } else {
                    console.log('üîå Socket non ancora pronto, riprovo...');
                    setTimeout(tryRegister, 500);
                }
            };

            // Se il socket √® gi√† connesso, registra subito
            if (socket && socket.connected) {
                tryRegister();
            } else {
                // Altrimenti aspetta che si connetta
                if (socket) {
                    socket.on('connect', tryRegister);
                } else {
                    // Socket non ancora inizializzato, riprova
                    setTimeout(tryRegister, 1000);
                }
            }
        }

        // Connessione WebSocket (opzionale)
        function initializeSocket() {
            if (typeof io === 'undefined') {
                console.log('Socket.io non caricato');
                return;
            }

            socket = io();

            socket.on('connect', () => {
                console.log('Connesso al server via WebSocket');
            });

            socket.on('disconnect', () => {
                console.log('Disconnesso dal server');
            });

            socket.on('registered', (data) => {
                if (data.success) {
                    console.log('‚úÖ Registrazione WebSocket confermata per partecipante');
                } else {
                    console.error('‚ùå Registrazione WebSocket fallita:', data);
                }
            });

            socket.on('round_started', (data) => {
                showBiddingPhase(data);
            });

            socket.on('offerte_update', (data) => {
                updateOffersStatus(data);
            });

            socket.on('timer_update', (timeLeft) => {
                // Timer non pi√π utilizzato - manteniamo per compatibilit√†
                console.log('Timer update (non utilizzato):', timeLeft);
            });

            socket.on('crediti_aggiornati', (data) => {
    playerData.credits = data.crediti;
    updateCreditsDisplay(); // AGGIUNTO: aggiorna entrambi i display
    
    // NUOVO: Salva crediti aggiornati
    saveSession();
    
    console.log('Crediti aggiornati:', data.crediti);
});

socket.on('round_ended', (data) => {
    console.log('Round terminato ricevuto:', data);
    showResultsPhase(data);
    updateMyTeamFromResults(data.round, data.risultati);
    
    // AGGIUNGI: Reset completo dell'interfaccia
    resetBiddingInterface();
    
    // NUOVO: Salva sessione aggiornata
    saveSession();
    
    // Torna alla modalit√† attesa
    showWaitingPhase();
});

// NUOVO: Gestisci conferma puntata
            socket.on('bid_confirmed', (data) => {
                console.log('‚úÖ Puntata confermata dal server:', data);

                // Feedback visivo - PUNTATA CONFERMATA
                const button = document.getElementById('confirmBidBtn');
                button.disabled = true;
                button.textContent = '‚úÖ Puntata Confermata';
                button.style.background = '#10b981';

                // Disabilita tutta l'interfaccia di puntata
                document.querySelectorAll('.player-card').forEach(card => {
                    card.style.pointerEvents = 'none';
                    card.style.opacity = '0.7';
                });
                document.getElementById('bidAmount').disabled = true;

                // Mostra messaggio di attesa
                setTimeout(() => {
                    alert('‚úÖ Puntata confermata!\n\nOra attendi che tutti completino le loro offerte.');
                }, 500);
            });

            socket.on('bid_error', (data) => {
                console.error('‚ùå Errore puntata:', data);
                alert('‚ùå Errore: ' + data.message);

                // Riabilita interfaccia in caso di errore
                resetBiddingInterface();
            });

            // NUOVO: Aggiungi questo event listener qui
            socket.on('aste_resettate', (data) => {
                console.log('üîÑ Aste resettate dal server:', data);

                // Aggiorna crediti
                playerData.credits = data.creditiRipristinati;
                updateCreditsDisplay();

                // Reset completo della squadra
                document.querySelectorAll('.team-slot').forEach(slot => {
                    slot.classList.remove('filled');
                    slot.classList.add('empty');
                    slot.style.borderColor = '#4a5568';
                    slot.style.backgroundColor = 'rgba(74, 85, 104, 0.3)';

                    const position = slot.dataset.position;
                    slot.innerHTML = `<strong>${position}</strong><br>-`;
                });

                // Aggiorna contatori
                document.getElementById('teamCount').textContent = '0';
                document.getElementById('teamPoints').textContent = '0';

                // Pulisci sessione salvata e risalva
                clearSavedSession();
                saveSession();

                // Mostra notifica
                alert('üîÑ Le aste sono state resettate dal Master!\n\nLa tua squadra √® stata azzerata e i crediti ripristinati.');
            });
        }

        // Registrazione giocatore MODIFICATA
        async function registerPlayer() {
            const name = document.getElementById('playerName').value.trim();
            const email = document.getElementById('playerEmail').value.trim();
            const phone = document.getElementById('playerPhone').value.trim();

            if (!name) {
                alert('Inserisci il tuo nome!');
                return;
            }

            try {
                // Registra nel database
                const response = await fetch('/api/partecipanti', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        nome: name,
                        email: email,
                        telefono: phone,
                        crediti: 2000
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    playerData.registered = true;
                    playerData.name = name;
                    playerData.id = result.id;
                    playerData.credits = 2000;

                    // NUOVO: Salva la sessione
                    saveSession();

                    // Registra socket quando √® pronto
                    registerSocketWhenReady();

                    // Mostra area gioco
                    document.getElementById('currentPlayer').textContent = name;
                    document.getElementById('playerCredits').textContent = 2000;

                    // NUOVO: Aggiorna anche il display crediti nella sezione bid
                    updateCreditsDisplay();

                    showGameArea();

                    alert('‚úÖ Registrato con successo!\n\nOra sei nel FantaGTS e in attesa che il Master avvii le aste.\n\nüí° La tua sessione verr√† salvata automaticamente.');

                } else {
                    const error = await response.json();
                    alert('‚ùå Errore registrazione: ' + error.error);
                }
            } catch (error) {
                alert('‚ùå Errore di connessione al server');
                console.error('Errore registrazione:', error);
            }
        }

        function showGameArea() {
            document.getElementById('registration-area').style.display = 'none';
            document.getElementById('game-area').style.display = 'block';
            showWaitingPhase();
        }

        function showWaitingPhase() {
            document.getElementById('waiting-phase').style.display = 'block';
            document.getElementById('bidding-phase').style.display = 'none';
        }

        function showBiddingPhase(data) {
            document.getElementById('waiting-phase').style.display = 'none';
            document.getElementById('bidding-phase').style.display = 'block';
            
            if (data && data.round) {
                document.getElementById('currentRound').textContent = data.round;
                loadAvailablePlayers(data.slots || []);
            }
        }
		
		function updateCreditsDisplay() {
    document.getElementById('creditsDisplay').textContent = playerData.credits;
    document.getElementById('playerCredits').textContent = playerData.credits;
}

function resetBiddingInterface() {
    // Riabilita input crediti
    document.getElementById('bidAmount').disabled = false;
    document.getElementById('bidAmount').value = '';
    
    // Riabilita tutti i controlli
    document.querySelectorAll('.player-card').forEach(card => {
        card.style.pointerEvents = 'auto';
        card.style.opacity = '1';
        card.classList.remove('selected');
    });
    
    // Reset pulsante conferma
    const confirmBtn = document.getElementById('confirmBidBtn');
    confirmBtn.disabled = true;
    confirmBtn.textContent = 'Conferma Puntata';
    confirmBtn.style.background = '#ef4444';
    
    // Nascondi sezione bid
    document.getElementById('bidSection').style.display = 'none';
    
    console.log('üîÑ Interfaccia di puntata resettata');
}

        function loadAvailablePlayers(slots) {
            const grid = document.getElementById('playersGrid');
            grid.innerHTML = '';

            // Se non abbiamo slots dal server, usa dati mock per test
            const players = slots.length > 0 ? slots : [
                { id: 'M1_ROSSO', giocatore_attuale: 'SPANO', colore: 'rosso' },
                { id: 'M1_BLU', giocatore_attuale: 'BIANCHI', colore: 'blu' },
                { id: 'M1_VERDE', giocatore_attuale: 'VERDI', colore: 'verde' }
            ];

            players.forEach(player => {
                const card = document.createElement('div');
                card.className = 'player-card';
                card.dataset.playerId = player.id;
                
                card.innerHTML = `
                    <div class="team-color-dot" style="background-color: ${player.colore}"></div>
                    <div class="player-name">${player.giocatore_attuale}</div>
                    <div style="font-size: 0.8em; opacity: 0.8;">Squadra ${player.colore}</div>
                `;
                
                card.addEventListener('click', () => selectPlayer(player));
                grid.appendChild(card);
            });
        }

        function selectPlayer(player) {
    // Rimuovi selezione precedente
    document.querySelectorAll('.player-card').forEach(card => {
        card.classList.remove('selected');
    });

    // Seleziona nuovo giocatore
    document.querySelector(`[data-player-id="${player.id}"]`).classList.add('selected');

    // Mostra sezione puntata
    document.getElementById('bidSection').style.display = 'block';
    document.getElementById('selectedPlayerInfo').innerHTML = `
        <strong>Selezionato: ${player.giocatore_attuale || player.name}</strong><br>
        <small>Squadra ${player.colore}</small>
    `;

    // AGGIUNTO: Aggiorna display crediti
    updateCreditsDisplay();

    // Abilita pulsante
    updateBidButton();
}

        function updateBidButton() {
            const button = document.getElementById('confirmBidBtn');
            const amount = parseInt(document.getElementById('bidAmount').value) || 0;
            const hasValidBid = amount > 0 && amount <= playerData.credits;
            const hasSelection = document.querySelector('.player-card.selected') !== null;

            button.disabled = !(hasSelection && hasValidBid);
            
            if (hasSelection && hasValidBid) {
                const playerName = document.querySelector('.player-card.selected .player-name').textContent;
                button.textContent = `Punta ${amount} su ${playerName}`;
            } else {
                button.textContent = 'Conferma Puntata';
            }
        }

        function confirmBid() {
            const amount = parseInt(document.getElementById('bidAmount').value);
            const selectedCard = document.querySelector('.player-card.selected');
            
            if (!selectedCard || !amount || amount <= 0) {
                alert('Seleziona un giocatore e inserisci un importo valido!');
                return;
            }

            const playerId = selectedCard.dataset.playerId;
            const playerName = selectedCard.querySelector('.player-name').textContent;

            // CONFERMA A 2 STEP
            const confirmMessage = `Stai per puntare\n\n${amount} crediti\n\nsu ${playerName}`;
            
            if (!confirm(confirmMessage)) {
                return; // Utente ha annullato
            }

            // Invia offerta al server se socket disponibile
            if (socket && socket.connected) {
                socket.emit('place_bid', {
                    round: document.getElementById('currentRound').textContent,
                    slot: playerId,
                    importo: amount
                });
            }

            // Feedback visivo - PUNTATA CONFERMATA
            const button = document.getElementById('confirmBidBtn');
            button.disabled = true;
            button.textContent = '‚úÖ Puntata Confermata';
            button.style.background = '#10b981';

            // Disabilita tutta l'interfaccia di puntata
            document.querySelectorAll('.player-card').forEach(card => {
                card.style.pointerEvents = 'none';
                card.style.opacity = '0.7';
            });
            document.getElementById('bidAmount').disabled = true;
            document.querySelectorAll('.quick-bid').forEach(btn => btn.disabled = true);

            alert(`‚úÖ Puntata confermata!\n\nOra attendi che tutti completino le loro offerte.`);
        }

        function updateOffersStatus(data) {
            const statusEl = document.getElementById('offersStatus');
            const messageEl = document.getElementById('offersMessage');
            
            if (data.mancano > 0) {
                statusEl.textContent = `${data.offerteRicevute}/${data.totalePartecipanti}`;
                statusEl.style.color = '#f59e0b';
                messageEl.textContent = `Mancano ${data.mancano} offerte per proseguire`;
            } else {
                statusEl.textContent = '‚úÖ Tutti hanno offerto!';
                statusEl.style.color = '#10b981';
                messageEl.textContent = 'Elaborazione risultati in corso...';
            }
        }

        function updateTimer(timeLeft) {
            // Funzione mantenuta per compatibilit√† ma non pi√π utilizzata
            console.log('Timer non utilizzato:', timeLeft);
        }

        function showResultsPhase(data) {
            // TODO: Implementare visualizzazione risultati
            alert('Round terminato!');
            showWaitingPhase();
        }

function updateMyTeamFromResults(round, risultati) {
    // Trova i miei acquisti in questo round
    const mieiAcquisti = risultati.filter(r => r.nome === playerData.name);
    
    console.log('üéØ Risultati completi ricevuti:', risultati);
    console.log('üéØ I miei acquisti:', mieiAcquisti);
    
    mieiAcquisti.forEach(acquisto => {
        // Estrai informazioni dal slot (es: "M1_ROSSO")
        const [posizione, coloreSquadra] = acquisto.slot.split('_');
        
        console.log(`üîç Debug slot: "${acquisto.slot}" ‚Üí posizione: "${posizione}", colore: "${coloreSquadra}"`);
        
        // Trova lo slot corrispondente nella UI
        const slotElement = document.querySelector(`[data-position="${posizione}"]`);
        if (slotElement) {
            slotElement.classList.remove('empty');
            slotElement.classList.add('filled');
            
            // Trova il nome del giocatore dal database
            fetch(`/api/slot-info/${acquisto.slot}`)
                .then(response => response.json())
                .then(slotInfo => {
                    console.log(`üìä Slot info ricevuto:`, slotInfo);
                    console.log(`üé® Colore da slotInfo: "${slotInfo.colore}" vs colore da slot: "${coloreSquadra}"`);
                    
                    // Determina colore del testo in base al colore di sfondo
                    const textColor = getTextColorForTeam(slotInfo.colore);
                    
                    slotElement.innerHTML = `
                    <strong style="color: ${textColor} !important;">${posizione}</strong><br>
                    <span style="color: ${textColor} !important;">${giocatore.giocatore_attuale}</span><br>
                    <small style="opacity: 0.8; color: ${textColor} !important;">Squadra: ${giocatore.colore}</small>
                `;
                    
                    // PROVA ENTRAMBI i colori per vedere quale √® corretto
                    const teamColorFromSlot = getTeamColor(coloreSquadra);
                    const teamColorFromAPI = getTeamColor(slotInfo.colore);
                    
                    console.log(`üé® Colore da slot "${coloreSquadra}" ‚Üí ${teamColorFromSlot}`);
                    console.log(`üé® Colore da API "${slotInfo.colore}" ‚Üí ${teamColorFromAPI}`);
                    
                    // Usa il colore dall'API che dovrebbe essere pi√π accurato
                    const teamColor = teamColorFromAPI;
                    
                    slotElement.style.borderColor = teamColor;
                    slotElement.style.borderWidth = '4px';
                    slotElement.style.borderStyle = 'solid';
                    
                    // Gestisce sia codici esadecimali che HSL
                    if (teamColor.startsWith('#')) {
                        slotElement.style.backgroundColor = teamColor + '80'; // Hex + trasparenza
                    } else {
                        // Per colori HSL, usa rgba con trasparenza
                        slotElement.style.backgroundColor = teamColor.replace('hsl', 'hsla').replace(')', ', 0.5)');
                    }
                })
                .catch((error) => {
                    console.error('‚ùå Errore fetch slot-info:', error);
                    // Fallback se API non disponibile
                    slotElement.innerHTML = `<strong>${posizione}</strong><br>Giocatore`;
                    const teamColor = getTeamColor(coloreSquadra);
                    console.log(`üé® Fallback colore: "${coloreSquadra}" ‚Üí ${teamColor}`);
                    
                    slotElement.style.borderColor = teamColor;
                    slotElement.style.borderWidth = '4px';
                    slotElement.style.borderStyle = 'solid';
                    
                    if (teamColor.startsWith('#')) {
                        slotElement.style.backgroundColor = teamColor + '80';
                    } else {
                        slotElement.style.backgroundColor = teamColor.replace('hsl', 'hsla').replace(')', ', 0.5)');
                    }
                });
        }
    });
    
    // Aggiorna contatori
    const slotsRiempiti = document.querySelectorAll('.team-slot.filled').length;
    document.getElementById('teamCount').textContent = slotsRiempiti;
}

function getTeamColor(nomeColore) {
    const colori = {
        // Colori base - MASCHILI
        'rosso': '#ef4444',
        'blu': '#3b82f6', 
        'verde': '#10b981',
        'giallo': '#f59e0b',
        'viola': '#8b5cf6',
        'arancione': '#f97316',
        'rosa': '#ec4899',
        'azzurro': '#06b6d4',
        'marrone': '#92400e',
        'nero': '#374151',
        'bianco': '#f3f4f6',
        'grigio': '#6b7280',
        'lime': '#84cc16',
        'indaco': '#6366f1',
        'fucsia': '#d946ef',
		
		// NUOVI COLORI PARTICOLARI
        'smeraldo': '#10b981',
        'royal': '#1e40af',
        'ciano': '#06b6d4',
        'lime': '#84cc16',
        'bordeaux': '#7c2d12',
        'crema': '#fef3c7',
        'lilla': '#c4b5fd',
        
        // Colori base - FEMMINILI
        'rossa': '#ef4444',
        'blu': '#3b82f6',        // blu non cambia
        'verde': '#10b981',      // verde non cambia  
        'gialla': '#f59e0b',
        'viola': '#8b5cf6',      // viola non cambia
        'arancione': '#f97316',  // arancione non cambia
        'rosa': '#ec4899',       // rosa non cambia
        'azzurra': '#06b6d4',
        'marrone': '#92400e',    // marrone non cambia
        'nera': '#374151',
        'bianca': '#f3f4f6',
        'grigia': '#6b7280',
        'lime': '#84cc16',       // lime non cambia
        'indaco': '#6366f1',     // indaco non cambia
        'fucsia': '#d946ef',     // fucsia non cambia
		
		// NUOVI COLORI PARTICOLARI - FEMMINILI
        'smeraldo': '#10b981',    // smeraldo non cambia
        'royal': '#1e40af',       // royal non cambia  
        'ciano': '#06b6d4',       // ciano non cambia
        'lime': '#84cc16',        // lime non cambia
        'bordeaux': '#7c2d12',    // bordeaux non cambia
        'crema': '#fef3c7',       // crema non cambia
        'lilla': '#c4b5fd',       // lilla non cambia
        
        // Varianti e sinonimi
        'celeste': '#06b6d4',
        'cielo': '#06b6d4',
        'blu chiaro': '#60a5fa',
        'blu chiara': '#60a5fa',
        'blu scuro': '#1e40af',
        'blu scura': '#1e40af',
        'rosso chiaro': '#f87171',
        'rossa chiara': '#f87171',
        'rosso scuro': '#b91c1c',
        'rossa scura': '#b91c1c',
        'verde chiaro': '#34d399',
        'verde chiara': '#34d399',
        'verde scuro': '#047857',
        'verde scura': '#047857',
        'giallo chiaro': '#fbbf24',
        'gialla chiara': '#fbbf24',
        'giallo scuro': '#d97706',
        'gialla scura': '#d97706',
        'viola chiaro': '#a78bfa',
        'viola chiara': '#a78bfa',
        'viola scuro': '#6d28d9',
        'viola scura': '#6d28d9',
        'arancio': '#f97316',
        'arancione chiaro': '#fb923c',
        'arancione chiara': '#fb923c',
        'arancione scuro': '#ea580c',
        'arancione scura': '#ea580c',
        'rosa chiaro': '#f9a8d4',
        'rosa chiara': '#f9a8d4',
        'rosa scuro': '#be185d',
        'rosa scura': '#be185d',
        'bordeaux': '#7c2d12',
        'magenta': '#e879f9',
        'ciano': '#22d3ee',
        'turchese': '#14b8a6',
        'oro': '#eab308',
        'dorato': '#eab308',
        'dorata': '#eab308',
        'argento': '#9ca3af',
        'argentato': '#9ca3af',
        'argentata': '#9ca3af',
        'bronzo': '#a16207',
        'beige': '#d6d3d1',
        'crema': '#fef3c7',
        'lavanda': '#c4b5fd',
        'menta': '#6ee7b7',
        'corallo': '#fb7185',
        'salmone': '#fca5a5',
        'petrolio': '#0f766e',
        'navy': '#1e3a8a',
        'militare': '#365314',
        'sabbia': '#fef3c7',
        
        // Altri sinonimi femminili
        'azzurra chiara': '#60a5fa',
        'azzurra scura': '#1e40af',
        'celeste chiara': '#60a5fa',
        'celeste scura': '#1e40af',
        'grigia chiara': '#9ca3af',
        'grigia scura': '#4b5563',
        'marrone chiaro': '#d2b48c',
        'marrone chiara': '#d2b48c',
        'marrone scuro': '#8b4513',
        'marrone scura': '#8b4513',
        'nera opaca': '#1f2937',
        'bianca pura': '#ffffff',
        
        // Colori particolari con varianti
        'fucsia chiara': '#f0abfc',
        'fucsia scura': '#a21caf',
        'magenta chiara': '#f0abfc',
        'magenta scura': '#a21caf',
        'lime chiaro': '#bef264',
        'lime chiara': '#bef264',
        'lime scuro': '#65a30d',
        'lime scura': '#65a30d'
    };
    
    const coloreLowerCase = nomeColore.toLowerCase().trim();
    
    // ‚úÖ PRIMA: Cerca corrispondenza diretta esatta
    if (colori[coloreLowerCase]) {
        console.log(`‚úÖ Colore trovato direttamente: "${coloreLowerCase}" ‚Üí ${colori[coloreLowerCase]}`);
        return colori[coloreLowerCase];
    }
    
    // ‚úÖ SECONDO: Cerca corrispondenze parziali solo se non trova quella esatta
    for (const [nome, codice] of Object.entries(colori)) {
        if (coloreLowerCase.includes(nome) || nome.includes(coloreLowerCase)) {
            console.log(`‚ö†Ô∏è Colore trovato parzialmente: "${coloreLowerCase}" tramite "${nome}" ‚Üí ${codice}`);
            return codice;
        }
    }
    
    // ‚úÖ ULTIMO RESORT: Genera colore solo se davvero non trova niente
    console.log(`‚ùå Colore non riconosciuto: "${coloreLowerCase}" ‚Üí generando colore casuale`);
    return generaColoreHash(nomeColore);
}

        function getTextColorForTeam(nomeColore) {
            // Colori chiari che necessitano testo scuro
            const coloriChiari = [
                'bianco', 'bianca', 'crema',
                'giallo chiaro', 'gialla chiara', 'lime chiaro', 'lime chiara',
                'rosa chiaro', 'rosa chiara',
                'celeste', 'azzurro chiaro', 'azzurra chiara',
                'verde chiaro', 'verde chiara', 'viola chiaro', 'viola chiara',
                'arancione chiaro', 'arancione chiara', 'grigio chiaro', 'grigia chiara',
                'argento', 'argentato', 'argentata', 'sabbia', 'beige', 'lavanda',
                'fucsia chiara', 'magenta chiara', 'oro', 'dorato', 'dorata'
            ];

            // Colori scuri che necessitano testo bianco
            const coloriScuri = [
                'nero', 'nera', 'blu', 'azzurro', 'azzurra', 'verde', 'verde scuro', 'verde scura',
                'rosso', 'rossa', 'rosso scuro', 'rossa scura', 'viola', 'viola scuro', 'viola scura',
                'marrone', 'marrone scuro', 'marrone scura', 'arancione', 'arancione scuro', 'arancione scura',
                'bordeaux', 'navy', 'militare', 'petrolio', 'indaco', 'blu scuro', 'blu scura',
                'grigio', 'grigia', 'grigio scuro', 'grigia scura', 'bronzo',
                'smeraldo', 'royal', 'ciano', 'turchese', 'fucsia', 'magenta',
                'lime scuro', 'lime scura', 'nera opaca', 'azzurra scura', 'celeste scura',
                'rosa', 'giallo', 'gialla'
            ];

            const coloreLowerCase = nomeColore.toLowerCase().trim();

            // Prima controlla se √® esplicitamente un colore chiaro
            const isColoreChiaro = coloriChiari.some(colore =>
                coloreLowerCase.includes(colore) || colore.includes(coloreLowerCase)
            );

            if (isColoreChiaro) {
                return '#1a202c'; // Testo scuro per sfondi chiari
            }

            // Poi controlla se √® esplicitamente un colore scuro
            const isColoreScuro = coloriScuri.some(colore =>
                coloreLowerCase.includes(colore) || colore.includes(coloreLowerCase)
            );

            if (isColoreScuro) {
                return '#ffffff'; // Testo bianco per sfondi scuri
            }

            // Default: testo bianco per colori non riconosciuti
            return '#ffffff';
        }

function generaColoreHash(str) {
    // Genera un colore consistente basato sul nome del colore
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // Converte a 32-bit integer
    }
    
    // Converte l'hash in un colore HSL per garantire colori vivaci
    const hue = Math.abs(hash) % 360;
    const saturation = 65 + (Math.abs(hash) % 35); // 65-100%
    const lightness = 45 + (Math.abs(hash) % 20);  // 45-65%
    
    return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
}

// NUOVA FUNZIONE: Logout
function logout() {
    if (confirm('Sei sicuro di voler uscire?\n\nDovrai reinserire i tuoi dati per rientrare.')) {
        clearSavedSession();
        playerData = {
            registered: false,
            name: '',
            id: '',
            credits: 2000
        };
        
        // Disconnetti socket
        if (socket && socket.connected) {
            socket.disconnect();
        }
        
        // Ricarica la pagina
        location.reload();
    }
}

        // Event listeners
        document.getElementById('bidAmount').addEventListener('input', updateBidButton);

        // Auto-focus
        document.getElementById('playerName').focus();

        console.log('‚úÖ FantaGTS Client inizializzato correttamente');
    </script>
</body>
</html>